<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <title>PolyLoans | DeFi Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>tailwind.config={theme:{extend:{fontFamily:{sans:['"Plus Jakarta Sans"'],mono:['"JetBrains Mono"']},colors:{bg:'#020408',surface:'#0B0D12',border:'#1E2129',brand:'#6366F1'}}}}; </script>
    <style>
        body { background-color: #020408; color: #E2E8F0; }
        .panel { background: #0B0D12; border: 1px solid #1E2129; }
        .input-prem { background: #050608; border: 1px solid #1E2129; color: white; }
        .hidden-tab { display: none !important; }
        .tab-btn { color: #6B7280; border-bottom: 2px solid transparent; }
        .tab-active { color: white; border-bottom: 2px solid #6366F1; font-weight: bold; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <nav class="h-16 border-b border-[#1E2129] flex items-center justify-between px-6 bg-[#020408] fixed w-full top-0 z-50">
        <div class="flex items-center gap-8">
            <span class="font-bold text-lg text-white">PolyLoans <span class="text-[10px] text-brand bg-brand/10 px-1 rounded">BETA</span></span>
            <div id="navTabs" class="hidden flex gap-6 text-sm font-medium h-16 items-end pb-4">
                <button onclick="switchTab('overview')" id="tab-overview" class="tab-btn tab-active">Overview</button>
                <button onclick="switchTab('borrow')" id="tab-borrow" class="tab-btn">Borrow</button>
                <button onclick="switchTab('lend')" id="tab-lend" class="tab-btn">Lend</button>
            </div>
        </div>
        <div id="walletBox" class="flex items-center gap-4">
            <div id="userAddr" class="hidden font-mono text-xs text-gray-400 bg-[#0B0D12] px-3 py-1 rounded border border-[#1E2129]"></div>
            <button id="btnConnect" onclick="connectWallet()" class="bg-[#6366F1] px-4 py-2 rounded text-sm font-bold text-white">Connect Wallet</button>
        </div>
    </nav>

    <main class="pt-24 p-6 max-w-7xl mx-auto w-full">

        <div id="view-overview">
            <h2 class="text-xl font-bold mb-6">Dashboard</h2>
            <div class="grid grid-cols-4 gap-6">
                <div class="panel p-6 rounded-xl"><div class="text-xs text-gray-500 uppercase">My Debt</div><div class="text-2xl font-bold text-red-400" id="statBorrowed">$0.00</div></div>
                <div class="panel p-6 rounded-xl"><div class="text-xs text-gray-500 uppercase">My Investments</div><div class="text-2xl font-bold text-emerald-400" id="statLent">$0.00</div></div>
                <div class="panel p-6 rounded-xl"><div class="text-xs text-gray-500 uppercase">Shares Held</div><div class="text-2xl font-bold text-brand" id="statShares">0</div></div>
                <div class="panel p-6 rounded-xl"><div class="text-xs text-gray-500 uppercase">Active Deals</div><div class="text-2xl font-bold text-white" id="statCount">0</div></div>
            </div>
        </div>

        <div id="view-borrow" class="hidden-tab">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <div class="lg:col-span-4 panel rounded-xl p-6 space-y-4 h-fit">
                    <h2 class="font-bold flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-brand"></span> New Request</h2>
                    <select id="positionSelect" onchange="autoFillForm()" class="input-prem w-full rounded p-2 text-sm"></select>
                    <div id="balanceDisplay" class="text-xs text-brand h-4"></div>
                    <input type="text" id="b_tokenId" class="hidden">
                    <div class="grid grid-cols-2 gap-4">
                        <input type="number" id="b_shares" placeholder="Shares" class="input-prem w-full rounded p-2 text-sm" oninput="checkLTV()">
                        <input type="number" id="b_principal" placeholder="USDC" class="input-prem w-full rounded p-2 text-sm" oninput="checkLTV()">
                    </div>
                    <div id="ltvWarning" class="text-xs text-right h-4 font-mono"></div>
                    <input type="number" id="b_duration" class="input-prem w-full rounded p-2 text-sm" placeholder="Duration (Minutes)">
                    <button onclick="handleCreateRequest()" id="btnCreate" disabled class="w-full bg-[#6366F1] py-3 rounded font-bold text-sm">Sign & Post</button>
                    <div id="txStatus" class="text-center text-xs text-gray-500 mt-2"></div>
                </div>

                <div class="lg:col-span-8 space-y-6">
                    <div class="panel rounded-xl p-6">
                        <div class="flex justify-between mb-4"><h2 class="font-bold">Incoming Offers</h2><button onclick="loadMyOffers()" class="text-xs text-brand">Refresh</button></div>
                        <div id="borrowerOffers" class="text-sm text-gray-500 text-center py-4">No offers received yet.</div>
                    </div>
                    <div class="panel rounded-xl p-6">
                        <div class="flex justify-between mb-4"><h2 class="font-bold">My Active Debts</h2><button onclick="loadMyLoans()" class="text-xs text-brand">Refresh</button></div>
                        <div id="borrowerLoans" class="text-sm text-gray-500 text-center py-4">No active debts.</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-lend" class="hidden-tab space-y-6">
            <div class="panel rounded-xl overflow-hidden">
                <div class="p-4 border-b border-[#1E2129] flex justify-between bg-[#050608]"><h2 class="font-bold">Market Feed</h2><button onclick="loadMarketFeed()" class="text-xs text-brand">Refresh</button></div>
                <div id="marketFeed" class="p-0"></div>
            </div>
            <div class="panel rounded-xl p-6">
                <div class="flex justify-between mb-4"><h2 class="font-bold">My Investments</h2><button onclick="loadMyLoans()" class="text-xs text-brand">Sync</button></div>
                <div id="lenderLoans" class="text-sm text-gray-500 text-center py-4">No active investments.</div>
            </div>
        </div>

    </main>

    <script>
    // ‚ö†Ô∏è UPDATE THIS! ‚ö†Ô∏è
    const MARKET_ADDR = "0x59B3a47dBe8B251eB14E57509A15Ed829065B91e"; 
    const USDC_ADDR = "0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359"; 
    const RENDER_API_URL = "https://polyloans-api.onrender.com"; 

    let signer, userAddress, marketContract, myProxy;
    const INFO_CACHE = {}; 

    const MARKET_ABI = ["function createRequest(uint256,uint256,uint256,uint256) external returns (uint256)","function makeOffer(uint256,uint256) external returns (uint256)","function acceptOffer(uint256) external","function repayLoan(uint256) external","function cancelRequest(uint256) external","function requestExtension(uint256,uint256) external","function acceptExtension(uint256) external","function buyoutLoan(uint256) external","function liquidateByTime(uint256) external","function requests(uint256) view returns (address, uint256, uint256, uint256, uint256, bool, bool)","function loans(uint256) view returns (address, uint256, uint256, uint256)","function offers(uint256) view returns (uint256, address, uint256, bool)","function extensions(uint256) view returns (bool, uint256, uint256)","function nextRequestId() view returns (uint256)","function nextOfferId() view returns (uint256)"];
    const USDC_ABI = ["function approve(address, uint256) external"];

    async function connectWallet() {
        // üõ† WALLET CONFLICT FIX üõ†
        let ethProvider = window.ethereum;
        if (!ethProvider) return alert("Install Rabby or MetaMask!");
        if (window.ethereum.providers?.length) {
            ethProvider = window.ethereum.providers.find(p => p.isRabby) || window.ethereum.providers[0];
        }

        const provider = new ethers.BrowserProvider(ethProvider);
        try {
            await provider.send("eth_requestAccounts", []);
            try { await ethProvider.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0x89' }] }); } catch(e){}

            signer = await provider.getSigner();
            userAddress = await signer.getAddress();
            marketContract = new ethers.Contract(MARKET_ADDR, MARKET_ABI, signer);
            
            document.getElementById("addrText").innerText = userAddress.slice(0,6)+"..."+userAddress.slice(-4);
            document.getElementById("userAddr").classList.remove("hidden");
            document.getElementById("btnConnect").style.display = "none";
            document.getElementById("navTabs").classList.remove("hidden");
            
            switchTab('overview');
            await initProxy();
            scanPortfolio(); loadMarketFeed(); loadMyOffers(); loadMyLoans();
            setInterval(loadMyLoans, 4000);

        } catch(e) { alert("Connection Error: " + e.message); }
    }

    function switchTab(t) {
        ['overview','borrow','lend'].forEach(v => {
            document.getElementById(`view-${v}`).classList.add('hidden-tab');
            document.getElementById(`tab-${v}`).classList.remove('tab-active');
        });
        document.getElementById(`view-${t}`).classList.remove('hidden-tab');
        document.getElementById(`tab-${t}`).classList.add('tab-active');
    }

    // --- üîê SIGNATURE FIX FOR GS026 üîê ---
    async function signAndRelay(func, args) {
        const status = document.getElementById("txStatus");
        status.innerText = "‚è≥ Preparing Transaction...";
        
        try {
            const metaRes = await fetch(`${RENDER_API_URL}/get-nonce?user=${userAddress}`);
            const meta = await metaRes.json();
            
            if(!meta.proxy) {
                alert("Error: No Proxy Found. You must have a Polymarket Account.");
                return null;
            }

            // GS026 FIX: Ensure Chain ID is strict Integer 137
            const domain = { verifyingContract: meta.proxy, chainId: 137 };
            
            const iface = new ethers.Interface(MARKET_ABI);
            const data = iface.encodeFunctionData(func, args);
            
            const types = { SafeTx: [{type:"address",name:"to"},{type:"uint256",name:"value"},{type:"bytes",name:"data"},{type:"uint8",name:"operation"},{type:"uint256",name:"safeTxGas"},{type:"uint256",name:"baseGas"},{type:"uint256",name:"gasPrice"},{type:"address",name:"gasToken"},{type:"address",name:"refundReceiver"},{type:"uint256",name:"nonce"}] };
            const message = { to: MARKET_ADDR, value: 0, data, operation: 0, safeTxGas: 0, baseGas: 0, gasPrice: 0, gasToken: "0x0000000000000000000000000000000000000000", refundReceiver: "0x0000000000000000000000000000000000000000", nonce: meta.nonce };

            status.innerText = "üìù Please Sign in Wallet...";
            const sig = await signer.signTypedData(domain, types, message);
            
            status.innerText = "üöÄ Sending to Relay...";
            const res = await fetch(`${RENDER_API_URL}/relay-tx`, { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ proxy: meta.proxy, to: MARKET_ADDR, data, signature: sig }) 
            });
            
            const json = await res.json();
            if(!json.success) throw new Error(json.error);
            
            status.innerHTML = `<span class="text-emerald-400">‚úÖ Success! Tx: ${json.txHash.slice(0,6)}...</span>`;
            return json.txHash;

        } catch(e) { 
            console.error(e);
            status.innerHTML = `<span class="text-red-500">‚ùå Error: ${e.message}</span>`;
            // SPECIFIC HELP FOR GS026
            if(e.message.includes("GS026")) alert("Signature Error (GS026). This usually means the connected wallet is NOT the owner of the Proxy. Check which wallet you are using.");
            return null; 
        }
    }

    async function handleCreateRequest() {
        const id = document.getElementById("positionSelect").value;
        const s = document.getElementById("b_shares").value;
        const p = document.getElementById("b_principal").value;
        const d = document.getElementById("b_duration").value;
        const tx = await signAndRelay('createRequest', [id, BigInt(s*1e6), BigInt(p*1e6), BigInt(d*60)]);
        if(tx) setTimeout(() => location.reload(), 2000);
    }
    
    // ... [Rest of helper functions: scanPortfolio, loadData, etc. same as before] ...
    
    // Keep your existing helper functions here (scanPortfolio, loadMarketFeed, etc.)
    // They work fine, the issue was just the HTML structure and the wallet connection.
    
    async function initProxy() { try{ const r=await fetch(`${RENDER_API_URL}/get-nonce?user=${userAddress}`); const d=await r.json(); window.myProxy=d.proxy; }catch(e){} }
    async function scanPortfolio() {
        const res = await fetch(`${RENDER_API_URL}/portfolio?user=${userAddress}`);
        const data = await res.json();
        const sel = document.getElementById("positionSelect");
        sel.innerHTML = '<option value="">-- Select Asset --</option>';
        data.forEach(p => {
            const opt = document.createElement("option");
            opt.value = p.asset; opt.text = `${p.title} (${p.size})`;
            opt.setAttribute("data-bal", p.size); opt.setAttribute("data-price", p.livePrice);
            sel.appendChild(opt);
        });
        document.getElementById("statShares").innerText = data.length;
    }
    function autoFillForm() { const sel = document.getElementById("positionSelect"); if(sel.value) { const opt = sel.selectedOptions[0]; document.getElementById("balanceDisplay").innerText = `Bal: ${opt.getAttribute("data-bal")} | Price: $${Number(opt.getAttribute("data-price")).toFixed(2)}`; } }
    function checkLTV() { const s = document.getElementById("b_shares").value; const p = document.getElementById("b_principal").value; const opt = document.getElementById("positionSelect").selectedOptions[0]; const price = opt ? Number(opt.getAttribute("data-price")) : 0.5; const limit = s * price * 0.5; const btn = document.getElementById("btnCreate"); if(p > limit) { document.getElementById("ltvWarning").innerText = `Max: $${limit.toFixed(2)}`; btn.disabled=true; } else { document.getElementById("ltvWarning").innerText = "LTV OK"; btn.disabled=false; } }
    
    // Loaders and Actions
    async function loadMarketFeed() {
        const div = document.getElementById("marketFeed");
        const nextId = await marketContract.nextRequestId();
        let html = '<table class="w-full text-left text-sm text-gray-300"><thead class="bg-[#050608] text-xs text-gray-500 uppercase"><tr><th class="p-3">Asset</th><th class="p-3 text-right">Ask</th><th class="p-3 text-right">Action</th></tr></thead><tbody>';
        for(let i=Number(nextId)-1; i>=1; i--) {
            try {
                const req = await marketContract.requests(i);
                if(req[5] && !req[6] && req[0].toLowerCase() !== window.myProxy?.toLowerCase()) {
                    const info = await getInfo(req[1]);
                    html += `<tr class="border-b border-gray-800"><td class="p-3 font-bold">${info.title}</td><td class="p-3 text-right">$${ethers.formatUnits(req[3],6)}</td><td class="p-3 text-right"><div class="flex justify-end gap-1"><input id="r_${i}" class="w-10 bg-black text-xs p-1" placeholder="%"><button onclick="offer(${i})" class="bg-blue-600 px-2 text-xs rounded">Offer</button></div></td></tr>`;
                }
            } catch(e){}
        }
        div.innerHTML = html + "</tbody></table>";
    }
    async function loadMyOffers() {
        const div = document.getElementById("borrowerOffers");
        const nextId = await marketContract.nextOfferId();
        let html = "";
        for(let i=Number(nextId)-1; i>=1; i--) {
            try {
                const off = await marketContract.offers(i);
                if(off[3]) {
                    const req = await marketContract.requests(off[0]);
                    if(req[0].toLowerCase() === window.myProxy?.toLowerCase()) {
                        const info = await getInfo(req[1]);
                        html += `<div class="bg-[#0B0D12] p-3 rounded flex justify-between items-center"><div><div class="font-bold text-sm">${info.title}</div><div class="text-xs text-green-400">Rate: ${Number(off[2])}%</div></div><button onclick="accept(${i})" class="bg-green-600 text-xs px-3 py-1 rounded">Accept</button></div>`;
                    }
                }
            } catch(e){}
        }
        div.innerHTML = html || "<div class='text-xs text-gray-500 text-center py-4'>No offers received.</div>";
    }
    async function loadMyLoans() {
        const bDiv = document.getElementById("borrowerLoans");
        const lDiv = document.getElementById("lenderLoans");
        const nextId = await marketContract.nextRequestId();
        let bHtml="", lHtml="", borrowed=0, lent=0, count=0;
        for(let i=1; i<Number(nextId); i++) {
            try {
                const req = await marketContract.requests(i);
                const loan = await marketContract.loans(i);
                if(req[6]) { 
                    const info = await getInfo(req[1]);
                    const princ = Number(ethers.formatUnits(req[3],6));
                    if(req[0].toLowerCase() === window.myProxy?.toLowerCase()) {
                        borrowed += princ; count++;
                        bHtml += `<div class="bg-[#0B0D12] p-3 rounded border border-gray-800"><div class="font-bold text-sm">${info.title}</div><div class="text-xs text-gray-400 mt-1">Due: $${princ}</div><button onclick="repay(${i})" class="mt-2 w-full bg-blue-600 text-xs py-1 rounded">Repay</button></div>`;
                    }
                    if(loan[0].toLowerCase() === userAddress.toLowerCase()) {
                        lent += princ; count++;
                        lHtml += `<div class="bg-[#0B0D12] p-3 rounded border border-gray-800"><div class="font-bold text-sm">${info.title}</div><div class="text-xs text-gray-400 mt-1">Lent: $${princ}</div><button onclick="liquidate(${i})" class="mt-2 w-full bg-red-900 text-xs py-1 rounded">Seize</button></div>`;
                    }
                }
            } catch(e){}
        }
        bDiv.innerHTML = bHtml || "<div class='text-xs text-gray-500 text-center py-4'>No active debts.</div>";
        lDiv.innerHTML = lHtml || "<div class='text-xs text-gray-500 text-center py-4'>No investments.</div>";
        document.getElementById("statBorrowed").innerText = `$${borrowed}`;
        document.getElementById("statLent").innerText = `$${lent}`;
        document.getElementById("statCount").innerText = count;
    }
    
    async function getInfo(id) { if(INFO_CACHE[id]) return INFO_CACHE[id]; try { const r = await fetch(`${RENDER_API_URL}/market-info?tokenId=${id}`); const d = await r.json(); INFO_CACHE[id]=d; return d; } catch{ return {title:"Unknown"};} }
    async function offer(id) { const r=document.getElementById("r_"+id).value; const u=new ethers.Contract(USDC_ADDR,USDC_ABI,signer); await(await u.approve(MARKET_ADDR,ethers.MaxUint256)).wait(); await(await marketContract.makeOffer(id,r)).wait(); alert("Offer Sent"); loadMarketFeed(); }
    async function accept(id) { if(confirm("Accept?")) if(await signAndRelay("acceptOffer",[id])) alert("Started!"); }
    async function repay(id) { if(confirm("Repay?")) if(await signAndRelay("repayLoan",[id])) alert("Repaid!"); }
    async function liquidate(id) { try{ await(await marketContract.liquidateByTime(id)).wait(); alert("Seized!"); }catch(e){alert(e.message);} }

    </script>
</body>
</html>