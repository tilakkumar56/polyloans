<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PolyLoans | Dashboard</title>
    <!-- Tailwind & Ethers -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'], mono: ['"JetBrains Mono"', 'monospace'] },
                    colors: { 
                        bg: '#020408', 
                        surface: '#0B0D12', 
                        border: '#1E2129',
                        brand: '#6366F1', // Indigo
                        brandHover: '#4F46E5'
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #020408; color: #E2E8F0; }
        .panel { background: #0B0D12; border: 1px solid #1E2129; }
        .input-premium { background: #050608; border: 1px solid #1E2129; color: white; transition: all 0.2s; }
        .input-premium:focus { border-color: #6366F1; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); outline: none; }
        
        .btn-primary { background: #6366F1; color: white; transition: 0.2s; box-shadow: 0 4px 14px 0 rgba(99, 102, 241, 0.39); }
        .btn-primary:hover:not(:disabled) { background: #4F46E5; transform: translateY(-1px); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; background: #1E2129; color: #6B7280; box-shadow: none; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #020408; }
        ::-webkit-scrollbar-thumb { background: #1E2129; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #2D3748; }
    </style>
</head>
<body class="min-h-screen flex flex-col bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-indigo-900/20 via-[#020408] to-[#020408]">

    <!-- Navbar -->
    <nav class="h-20 border-b border-[#1E2129] flex items-center justify-between px-8 bg-[#020408]/80 backdrop-blur-md sticky top-0 z-50">
        <a href="/" class="flex items-center gap-3 group">
            <div class="w-8 h-8 bg-brand rounded flex items-center justify-center font-bold text-white shadow-lg shadow-indigo-500/20 group-hover:scale-105 transition">‚ñ≤</div>
            <span class="font-bold text-lg tracking-tight text-white">PolyLoans <span class="text-[10px] bg-indigo-500/10 text-indigo-300 border border-indigo-500/20 px-1.5 py-0.5 rounded ml-1">APP</span></span>
        </a>
        
        <div class="flex items-center gap-4">
            <div id="userAddr" class="hidden font-mono text-xs bg-[#0B0D12] border border-[#1E2129] px-4 py-2 rounded text-indigo-300"></div>
            <button id="btnConnect" onclick="connectWallet()" class="btn-primary px-6 py-2.5 rounded-lg text-sm font-bold">
                Connect Wallet
            </button>
        </div>
    </nav>

    <!-- Main Grid -->
    <main class="flex-1 p-8 grid grid-cols-1 lg:grid-cols-12 gap-8 max-w-[1600px] mx-auto w-full">

        <!-- LEFT: BORROW -->
        <section class="lg:col-span-4 space-y-6">
            <div class="panel rounded-2xl p-6 relative overflow-hidden">
                <!-- Header -->
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold text-white">Borrow Liquidity</h2>
                    <span class="text-[10px] font-bold text-indigo-400 bg-indigo-900/20 px-2 py-1 rounded border border-indigo-900/50">STEP 1</span>
                </div>

                <!-- Form -->
                <div class="space-y-5">
                    <div>
                        <label class="text-xs font-bold text-gray-500 mb-2 block uppercase tracking-wider">Collateral Asset</label>
                        <select id="positionSelect" onchange="autoFillForm()" class="input-premium w-full rounded-xl px-4 py-3 text-sm cursor-pointer appearance-none">
                            <option>-- Connect Wallet First --</option>
                        </select>
                        <div id="priceDisplay" class="mt-2 text-xs h-5"></div>
                    </div>

                    <!-- Hidden ID -->
                    <input type="text" id="b_tokenId" class="hidden">

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-bold text-gray-500 mb-2 block uppercase tracking-wider">Lock Shares</label>
                            <input type="number" id="b_shares" placeholder="0" class="input-premium w-full rounded-xl px-4 py-3 text-sm font-mono" oninput="checkLTV()">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500 mb-2 block uppercase tracking-wider">Get USDC</label>
                            <input type="number" id="b_principal" placeholder="0.00" class="input-premium w-full rounded-xl px-4 py-3 text-sm font-mono" oninput="checkLTV()">
                        </div>
                    </div>

                    <div id="ltvWarning" class="text-xs h-5 font-mono text-right"></div>

                    <div>
                        <label class="text-xs font-bold text-gray-500 mb-2 block uppercase tracking-wider">Duration (Days)</label>
                        <input type="number" id="b_duration" placeholder="0 (Negotiable)" value="0" class="input-premium w-full rounded-xl px-4 py-3 text-sm font-mono">
                    </div>

                    <button id="btnCreate" onclick="createRequest()" disabled class="w-full btn-primary py-4 rounded-xl text-sm font-bold mt-2">
                        Post Request
                    </button>
                    <div id="b_status" class="text-center text-xs mt-3 text-gray-500 font-mono"></div>
                </div>
            </div>

            <!-- Active Loans Mini -->
            <div class="panel rounded-2xl p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider">My Active Debts</h3>
                    <button onclick="loadActiveLoans()" class="text-xs text-indigo-400 hover:text-white transition">‚Üª</button>
                </div>
                <div id="activeLoans" class="space-y-3">
                    <div class="text-center py-8 text-gray-700 text-xs font-medium">No active loans</div>
                </div>
            </div>
        </section>

        <!-- RIGHT: LEND -->
        <section class="lg:col-span-8 space-y-6">
            <!-- Market Feed -->
            <div class="panel rounded-2xl overflow-hidden flex flex-col h-[520px]">
                <div class="p-5 border-b border-[#1E2129] flex justify-between items-center bg-[#050608]/50">
                    <h2 class="font-bold text-white text-sm uppercase tracking-wide flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span> Market Feed
                    </h2>
                    <button onclick="loadMarketFeed()" class="text-xs text-gray-500 hover:text-white transition">Refresh</button>
                </div>
                
                <div class="overflow-y-auto flex-1 p-0 bg-[#020408]">
                    <table class="w-full text-left border-collapse">
                        <thead class="sticky top-0 bg-[#0B0D12] z-10 text-[10px] text-gray-500 uppercase font-bold tracking-wider">
                            <tr>
                                <th class="p-4 border-b border-[#1E2129]">Asset</th>
                                <th class="p-4 border-b border-[#1E2129] text-right">Collateral</th>
                                <th class="p-4 border-b border-[#1E2129] text-right">Ask (USDC)</th>
                                <th class="p-4 border-b border-[#1E2129] text-right">Duration</th>
                                <th class="p-4 border-b border-[#1E2129] text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody id="marketFeed" class="text-sm divide-y divide-[#1E2129] text-gray-300">
                            <tr><td colspan="5" class="p-16 text-center text-gray-600">Connecting to Polygon network...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Offers Box -->
            <div class="panel rounded-2xl p-5">
                <div class="flex justify-between items-center mb-4 pb-2 border-b border-[#1E2129]">
                    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Incoming Offers</h3>
                    <button onclick="loadMyOffers()" class="text-xs text-indigo-400 hover:text-white">Sync</button>
                </div>
                <div id="myOffers" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <p class="text-xs text-gray-600 col-span-2 text-center py-4">No offers received.</p>
                </div>
            </div>

        </section>

    </main>

    <!-- JS LOGIC PRESERVED -->
    <script>
    const MARKET_ADDR = "0xf8bF64E5c8f42002119B8Dbf516a9c5eD06cc2e5"; 
    const USDC_ADDR = "0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174"; 
    const PROXY_ADDR = "0x06CF8B375BD12E7256F8Da3e695857226b2b36d7"; 
    const RENDER_API_URL = "https://polyloans-api.onrender.com"; 

    let signer, userAddress, marketContract;
    const INFO_CACHE = {}; 
    
    // --- ABIs ---
    const MARKET_ABI = ["function makeOffer(uint256, uint256, uint256) external returns (uint256)","function cancelOffer(uint256) external","function requests(uint256) view returns (address, uint256, uint256, uint256, uint256, bool)","function offers(uint256) view returns (uint256, address, uint256, uint256, bool)","function activeLoans(uint256) view returns (address, address, uint256, uint256, uint256, uint256, uint256, uint256)","function nextRequestId() view returns (uint256)","function nextOfferId() view returns (uint256)","function liquidateByTime(uint256) external"];
    const USDC_ABI = ["function approve(address, uint256) external"];

    async function connectWallet() {
        if (!window.ethereum) return alert("Install Rabby!");
        const provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();
        userAddress = await signer.getAddress();
        marketContract = new ethers.Contract(MARKET_ADDR, MARKET_ABI, signer);
        
        document.getElementById("userAddr").classList.remove("hidden");
        document.getElementById("userAddr").innerText = userAddress.slice(0,6) + "..." + userAddress.slice(-4);
        document.getElementById("btnConnect").style.display = "none";
        
        scanPortfolio();
        loadMarketFeed(); 
        loadMyOffers();
        loadActiveLoans();
        setInterval(loadActiveLoans, 2000); 
    }

    async function getMarketInfo(tokenId) {
        if(INFO_CACHE[tokenId]) return INFO_CACHE[tokenId];
        try {
            const res = await fetch(`${RENDER_API_URL}/market-info?tokenId=${tokenId}`);
            const data = await res.json();
            const info = { title: data.title || "Unknown Market", link: data.slug ? `https://polymarket.com/event/${data.slug}` : "#" };
            INFO_CACHE[tokenId] = info;
            return info;
        } catch(e) { return { title: "Error Fetching", link: "#" }; }
    }

    async function scanPortfolio() {
        const select = document.getElementById("positionSelect");
        select.innerHTML = '<option>üîç Scanning...</option>';
        try {
            const res = await fetch(`${RENDER_API_URL}/portfolio?user=${userAddress}`);
            const data = await res.json();
            if (data.length === 0) { select.innerHTML = '<option>‚ùå No shares found</option>'; return; }

            select.innerHTML = '<option value="">-- Select a Position --</option>';
            data.forEach(p => {
                const opt = document.createElement("option");
                opt.value = p.asset || p.asset_id;
                opt.setAttribute("data-balance", p.size);
                const price = p.livePrice ? Number(p.livePrice) : 0;
                opt.setAttribute("data-price", price);
                INFO_CACHE[opt.value] = { title: p.title, link: p.slug ? `https://polymarket.com/event/${p.slug}` : "#" };
                opt.text = `${p.title} (${p.outcome}) - ${Number(p.size).toFixed(2)} Shares`;
                select.appendChild(opt);
            });
        } catch(e) { console.error(e); select.innerHTML = '<option>‚ö†Ô∏è Error Scanning</option>'; }
    }

    function autoFillForm() { 
        const sel = document.getElementById("positionSelect");
        const opt = sel.options[sel.selectedIndex];
        const display = document.getElementById("priceDisplay");
        const btn = document.getElementById("btnCreate");

        if(opt.value) {
            document.getElementById("b_tokenId").value = opt.value;
            const price = Number(opt.getAttribute("data-price"));
            
            if (price < 0.90 && price > 0) {
                display.innerHTML = `<span class="text-red-500 font-bold">‚ö†Ô∏è Low Price ($${price.toFixed(2)}). Lenders may reject.</span>`;
            } else if (price == 0) {
                display.innerHTML = `<span class="text-yellow-500">‚ö†Ô∏è Price Unknown. Manual Risk.</span>`;
            } else {
                display.innerHTML = `<span class="text-emerald-400 font-bold">‚úÖ High Quality ($${price.toFixed(2)})</span>`;
            }
            btn.disabled = false;
        }
    }

    function checkLTV() {
        const shares = Number(document.getElementById("b_shares").value);
        const principal = Number(document.getElementById("b_principal").value);
        const warning = document.getElementById("ltvWarning");
        const sel = document.getElementById("positionSelect");
        const opt = sel.options[sel.selectedIndex];
        const price = opt && opt.value ? Number(opt.getAttribute("data-price")) : 0;
        const effectivePrice = price > 0 ? price : 1.00;
        if (shares > 0) {
            const collateralValue = shares * effectivePrice;
            const maxLoan = collateralValue * 0.75; 
            const ltv = (principal / collateralValue) * 100;
            if (principal > maxLoan) {
                warning.innerHTML = `<span class="text-red-500">‚ùå >75% LTV (Max: $${maxLoan.toFixed(2)})</span>`;
                document.getElementById("btnCreate").disabled = true;
            } else {
                warning.innerHTML = `<span class="text-emerald-400">‚úÖ LTV: ${ltv.toFixed(1)}%</span>`;
                document.getElementById("btnCreate").disabled = false;
            }
        }
    }

    async function createRequest() {
        const id = document.getElementById("b_tokenId").value;
        const shares = document.getElementById("b_shares").value; 
        const principal = document.getElementById("b_principal").value; 
        const duration = document.getElementById("b_duration").value || 0;
        const status = document.getElementById("b_status");
        status.innerText = "‚è≥ Requesting...";
        await fetch(`${RENDER_API_URL}/create-request`, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ tokenId: id, shares, principal, duration, userAddress })
        });
        status.innerText = "‚úÖ Posted!";
        setTimeout(loadMarketFeed, 3000);
    }

    async function loadMarketFeed() {
        const tbody = document.getElementById("marketFeed");
        try {
            const nextId = await marketContract.nextRequestId();
            let html = "";
            for (let i = Number(nextId) - 1; i >= 1; i--) {
                const req = await marketContract.requests(i);
                if (req[5] === true) {
                    const principalFmt = ethers.formatUnits(req[3], 6);
                    const sharesFmt = ethers.formatUnits(req[2], 6);
                    const durationReq = Number(req[4]);
                    const durationText = durationReq > 0 ? (durationReq/86400).toFixed(1) + " Days" : "Flex";
                    const info = await getMarketInfo(req[1]);
                    html += `
                    <tr class="hover:bg-[#1E2129]/50 transition border-b border-[#1E2129]">
                        <td class="p-4">
                            <div class="font-bold text-gray-200 text-xs">${info.title}</div>
                            <a href="${info.link}" target="_blank" class="text-brand hover:text-white text-[10px] transition">View Market ‚Üó</a>
                        </td>
                        <td class="p-4 text-right font-mono text-emerald-400 text-xs">${sharesFmt}</td>
                        <td class="p-4 text-right font-mono text-white text-xs">$${principalFmt}</td>
                        <td class="p-4 text-right text-gray-500 text-xs">${durationText}</td>
                        <td class="p-4 text-right flex justify-end gap-2">
                            <input type="number" id="rate_${i}" placeholder="APR%" class="input-premium w-14 px-1 text-center text-xs rounded">
                            <button class="bg-brand hover:bg-brandHover text-white px-3 py-1 rounded text-xs" onclick="makeOffer(${i})">Offer</button>
                        </td>
                    </tr>`;
                }
            }
            tbody.innerHTML = html || '<tr><td colspan="5" class="p-12 text-center text-gray-600 text-xs italic">No active requests found.</td></tr>';
        } catch(e) { console.error(e); }
    }

    async function makeOffer(reqId) {
        const rate = Number(document.getElementById("rate_" + reqId).value) * 100;
        const usdc = new ethers.Contract(USDC_ADDR, USDC_ABI, signer);
        await (await usdc.approve(MARKET_ADDR, ethers.MaxUint256)).wait();
        await (await marketContract.makeOffer(reqId, rate, 0)).wait(); // Fixed duration for now
        alert("‚úÖ Offer Sent!");
        loadMyOffers(); 
    }

    async function loadMyOffers() {
        const div = document.getElementById("myOffers");
        try {
            const nextId = await marketContract.nextOfferId();
            let html = "";
            for (let i = Number(nextId) - 1; i >= 1; i--) {
                const offer = await marketContract.offers(i);
                if (offer[4] === true) {
                    const req = await marketContract.requests(offer[0]);
                    const info = await getMarketInfo(req[1]);
                    const rateFmt = Number(offer[2]) / 100;
                    
                    let action = "";
                    if (offer[1].toLowerCase() === userAddress.toLowerCase()) {
                         action = `<button class="w-full bg-red-900/30 text-red-400 py-2 rounded text-xs border border-red-900/50 hover:bg-red-900/50 transition" onclick="cancelOffer(${i})">Cancel</button>`;
                    } else if (req[0].toLowerCase() === PROXY_ADDR.toLowerCase()) {
                         action = `<button class="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-2 rounded text-xs font-bold shadow-lg shadow-emerald-900/30 transition" onclick="acceptOffer(${i})">Accept</button>`;
                    }

                    if(action) {
                        html += `
                        <div class="bg-[#0B0D12] p-4 rounded-xl border border-[#1E2129] hover:border-brand/50 transition">
                            <div class="flex justify-between items-start mb-3">
                                <span class="text-[10px] text-brand font-mono bg-brand/10 px-2 py-0.5 rounded">Offer #${i}</span>
                                <span class="text-xs text-emerald-400 font-bold">${rateFmt}% APR</span>
                            </div>
                            <p class="text-sm font-bold text-gray-200 truncate mb-3">${info.title}</p>
                            ${action}
                        </div>`;
                    }
                }
            }
            div.innerHTML = html || "<p class='text-xs text-center text-gray-600 italic py-4 col-span-2'>No offers received.</p>";
        } catch(e) { console.error(e); }
    }

    async function cancelOffer(id) {
        if(!confirm("Cancel?")) return;
        await fetch(`${RENDER_API_URL}/cancel-offer`, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ offerId: id, userAddress })
        });
        alert("‚úÖ Cancelled!");
        setTimeout(() => location.reload(), 2000);
    }

    async function acceptOffer(offerId) {
        if(!confirm("Accept deal?")) return;
        await fetch(`${RENDER_API_URL}/accept-offer`, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ offerId, userAddress })
        });
        alert("‚úÖ Accepted!");
        setTimeout(() => location.reload(), 2000);
    }

    async function loadActiveLoans() {
        const div = document.getElementById("activeLoans");
        try {
            const nextId = await marketContract.nextRequestId();
            let html = "";
            let found = false;
            for (let i = 1; i < Number(nextId); i++) {
                const loan = await marketContract.activeLoans(i);
                if (loan[6] > 0n && (loan[0].toLowerCase() === PROXY_ADDR.toLowerCase() || loan[1].toLowerCase() === userAddress.toLowerCase())) {
                    found = true;
                    const info = await getMarketInfo(loan[2]);
                    const principal = Number(ethers.formatUnits(loan[4], 6));
                    const totalDue = principal * 1.05; 
                    let action = "";
                    if(loan[0].toLowerCase() === PROXY_ADDR.toLowerCase()) {
                        action = `<button class="text-xs text-emerald-400 hover:text-white transition ml-auto" onclick="repayLoan(${i})">Repay</button>`;
                    }
                    html += `
                    <div class="flex justify-between items-center bg-[#0B0D12] p-3 rounded border border-[#1E2129]">
                        <div class="overflow-hidden mr-2">
                            <div class="text-xs font-bold text-gray-300 truncate">${info.title}</div>
                            <div class="text-[10px] text-gray-500 font-mono">Debt: $${totalDue.toFixed(2)}</div>
                        </div>
                        ${action}
                    </div>`;
                }
            }
            div.innerHTML = found ? html : "<div class='text-center py-6 text-gray-600 text-xs italic'>No active loans</div>";
        } catch(e) { console.error(e); }
    }

    async function repayLoan(id) {
        if(!confirm(`Repay Loan #${id}?`)) return;
        await fetch(`${RENDER_API_URL}/repay-loan`, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ requestId: id, userAddress })
        });
        alert("‚úÖ Repaid!");
        location.reload();
    }
    
    async function liquidate(id) {
        if(!confirm("Seize collateral?")) return;
        try {
            const tx = await marketContract.liquidateByTime(id);
            await tx.wait();
            alert("‚ö° ASSETS SEIZED!");
            location.reload();
        } catch(e) { alert(e.message); }
    }
    </script>
</body>
</html>
```