<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <title>PolyLoans | DeFi Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = { theme: { extend: { fontFamily: { sans: ['"Plus Jakarta Sans"'], mono: ['"JetBrains Mono"'] }, colors: { bg: '#020408', surface: '#0B0D12', border: '#1E2129', brand: '#6366F1' } } } }
    </script>
    <style>
        body { background-color: #020408; color: #E2E8F0; }
        .panel { background: #0B0D12; border: 1px solid #1E2129; }
        .input-prem { background: #050608; border: 1px solid #1E2129; color: white; }
        .btn-brand { background: #6366F1; color: white; } .btn-brand:hover { background: #4F46E5; }
        /* Tab States */
        .hidden-tab { display: none !important; }
        .tab-btn { border-bottom: 2px solid transparent; color: #6B7280; padding-bottom: 4px; }
        .tab-active { border-bottom: 2px solid #6366F1; color: white; font-weight: bold; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <nav class="h-16 border-b border-[#1E2129] flex items-center justify-between px-6 bg-[#020408] fixed w-full z-50 top-0">
        <div class="flex items-center gap-8">
            <span class="font-bold text-lg text-white">PolyLoans <span class="text-[10px] text-brand bg-brand/10 px-1 rounded">BETA</span></span>
            
            <div id="navTabs" class="hidden flex gap-6 text-sm font-medium h-16 items-end pb-4">
                <button onclick="switchTab('overview')" id="tab-overview" class="tab-btn tab-active">Overview</button>
                <button onclick="switchTab('borrow')" id="tab-borrow" class="tab-btn">Borrow</button>
                <button onclick="switchTab('lend')" id="tab-lend" class="tab-btn">Lend</button>
            </div>
        </div>

        <div id="walletBox" class="flex items-center gap-4">
            <div id="userAddr" class="hidden flex items-center gap-2 bg-[#0B0D12] border border-[#1E2129] px-3 py-1.5 rounded-full">
                <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                <span id="addrText" class="font-mono text-xs text-gray-300">0x00...0000</span>
            </div>
            <button id="btnConnect" onclick="connectWallet()" class="btn-brand px-4 py-2 rounded text-sm font-bold">Connect Wallet</button>
        </div>
    </nav>

    <main class="pt-24 p-6 max-w-7xl mx-auto w-full">

        <div id="view-overview" class="block">
            <h2 class="text-xl font-bold text-white mb-6">Account Overview</h2>
            <div class="grid grid-cols-4 gap-6">
                <div class="panel p-6 rounded-xl">
                    <div class="text-gray-500 text-xs uppercase font-bold tracking-wider">My Debt</div>
                    <div class="text-3xl font-bold text-red-400 mt-2" id="statBorrowed">$0.00</div>
                </div>
                <div class="panel p-6 rounded-xl">
                    <div class="text-gray-500 text-xs uppercase font-bold tracking-wider">My Investments</div>
                    <div class="text-3xl font-bold text-emerald-400 mt-2" id="statLent">$0.00</div>
                </div>
                <div class="panel p-6 rounded-xl">
                    <div class="text-gray-500 text-xs uppercase font-bold tracking-wider">Active Deals</div>
                    <div class="text-3xl font-bold text-white mt-2" id="statCount">0</div>
                </div>
                <div class="panel p-6 rounded-xl">
                    <div class="text-gray-500 text-xs uppercase font-bold tracking-wider">Positions Held</div>
                    <div class="text-3xl font-bold text-brand mt-2" id="statShares">0</div>
                </div>
            </div>
        </div>

        <div id="view-borrow" class="hidden-tab">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                
                <div class="lg:col-span-4 panel rounded-xl p-6 space-y-5 h-fit sticky top-24">
                    <h2 class="font-bold text-white flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-brand"></span> New Loan Request
                    </h2>
                    
                    <div>
                        <label class="text-xs text-gray-500 block mb-1.5 uppercase font-bold">Select Asset</label>
                        <select id="positionSelect" onchange="autoFillForm()" class="input-prem w-full rounded-lg p-3 text-sm"></select>
                        <div id="balanceDisplay" class="text-xs text-brand mt-2 font-mono h-4"></div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs text-gray-500 block mb-1.5 uppercase font-bold">Lock Shares</label>
                            <input type="number" id="b_shares" class="input-prem w-full rounded-lg p-3 text-sm font-mono" oninput="checkLTV()">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 block mb-1.5 uppercase font-bold">Get USDC</label>
                            <input type="number" id="b_principal" class="input-prem w-full rounded-lg p-3 text-sm font-mono" oninput="checkLTV()">
                        </div>
                    </div>
                    
                    <div id="ltvWarning" class="text-xs font-mono text-right h-4"></div>

                    <div>
                        <label class="text-xs text-gray-500 block mb-1.5 uppercase font-bold">Duration (Minutes)</label>
                        <input type="number" id="b_duration" class="input-prem w-full rounded-lg p-3 text-sm font-mono" placeholder="e.g. 60">
                    </div>

                    <button onclick="handleCreateRequest()" id="btnCreate" disabled class="w-full btn-brand py-3.5 rounded-lg font-bold text-sm shadow-lg shadow-indigo-500/20">Sign & Post Request</button>
                </div>

                <div class="lg:col-span-8 space-y-6">
                    <div class="panel rounded-xl p-6">
                        <div class="flex justify-between items-center mb-4 pb-4 border-b border-[#1E2129]">
                            <h3 class="font-bold text-white">Incoming Offers</h3>
                            <button onclick="loadMyOffers()" class="text-xs text-brand hover:text-white transition">Refresh</button>
                        </div>
                        <div id="borrowerOffers" class="grid grid-cols-1 gap-4">
                            <p class="text-gray-500 text-sm text-center py-4">No offers received yet.</p>
                        </div>
                    </div>

                    <div class="panel rounded-xl p-6">
                        <div class="flex justify-between items-center mb-4 pb-4 border-b border-[#1E2129]">
                            <h3 class="font-bold text-white">My Active Debts</h3>
                            <button onclick="loadMyLoans()" class="text-xs text-brand hover:text-white transition">Refresh</button>
                        </div>
                        <div id="borrowerLoans" class="space-y-4">
                            <p class="text-gray-500 text-sm text-center py-4">No active debts.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-lend" class="hidden-tab">
            <div class="space-y-6">
                <div class="panel rounded-xl overflow-hidden">
                    <div class="p-5 border-b border-[#1E2129] flex justify-between items-center bg-[#050608]">
                        <h2 class="font-bold text-white flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span> Market Feed
                        </h2>
                        <button onclick="loadMarketFeed()" class="text-xs text-brand hover:text-white transition">Refresh</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm text-gray-300">
                            <thead class="bg-[#0B0D12] text-xs uppercase text-gray-500 font-bold">
                                <tr>
                                    <th class="p-4">Market Asset</th>
                                    <th class="p-4 text-right">Collateral</th>
                                    <th class="p-4 text-right">Ask (USDC)</th>
                                    <th class="p-4 text-right">Duration</th>
                                    <th class="p-4 text-right">Action</th>
                                </tr>
                            </thead>
                            <tbody id="marketFeed"></tbody>
                        </table>
                    </div>
                </div>

                <div class="panel rounded-xl p-6">
                    <div class="flex justify-between items-center mb-4 pb-4 border-b border-[#1E2129]">
                        <h3 class="font-bold text-white">My Investments (Active Loans)</h3>
                        <button onclick="loadMyLoans()" class="text-xs text-brand hover:text-white transition">Sync</button>
                    </div>
                    <div id="lenderLoans" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <p class="text-gray-500 text-sm col-span-2 text-center py-4">You haven't funded any loans yet.</p>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
    // ⚠️ UPDATE THIS ADDRESS AFTER DEPLOY ⚠️
    const MARKET_ADDR = "0x59B3a47dBe8B251eB14E57509A15Ed829065B91e"; 
    const USDC_ADDR = "0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359"; 
    const RENDER_API_URL = "https://polyloans-api.onrender.com"; 

    let signer, userAddress, marketContract, myProxy;
    const INFO_CACHE = {}; 

    // CONTRACT ABI
    const MARKET_ABI = [
        "function createRequest(uint256,uint256,uint256,uint256) external returns (uint256)",
        "function makeOffer(uint256,uint256) external returns (uint256)",
        "function acceptOffer(uint256) external",
        "function repayLoan(uint256) external",
        "function cancelRequest(uint256) external",
        "function requestExtension(uint256,uint256) external",
        "function acceptExtension(uint256) external",
        "function buyoutLoan(uint256) external",
        "function liquidateByTime(uint256) external",
        "function requests(uint256) view returns (address, uint256, uint256, uint256, uint256, bool, bool)",
        "function loans(uint256) view returns (address, uint256, uint256, uint256)",
        "function offers(uint256) view returns (uint256, address, uint256, bool)",
        "function nextRequestId() view returns (uint256)",
        "function nextOfferId() view returns (uint256)"
    ];
    const USDC_ABI = ["function approve(address, uint256) external"];

    async function connectWallet() {
        if (!window.ethereum) return alert("Install Rabby!");
        try { await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0x89' }] }); } catch(e){}

        const provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();
        userAddress = await signer.getAddress();
        marketContract = new ethers.Contract(MARKET_ADDR, MARKET_ABI, signer);
        
        // Show Address & Tabs
        document.getElementById("addrText").innerText = userAddress.slice(0,6) + "..." + userAddress.slice(-4);
        document.getElementById("userAddr").classList.remove("hidden");
        document.getElementById("btnConnect").classList.add("hidden");
        document.getElementById("navTabs").classList.remove("hidden");
        
        // Init
        await initProxy();
        switchTab('overview');
        
        // Load Data
        scanPortfolio();
        loadMarketFeed(); 
        loadMyOffers();
        loadMyLoans();
        setInterval(updateTimers, 1000); 
    }

    function switchTab(tabName) {
        // Hide All Views
        ['overview','borrow','lend'].forEach(v => {
            document.getElementById(`view-${v}`).classList.add('hidden-tab');
            document.getElementById(`tab-${v}`).classList.remove('tab-active');
        });
        
        // Show Selected View
        document.getElementById(`view-${tabName}`).classList.remove('hidden-tab');
        document.getElementById(`tab-${tabName}`).classList.add('tab-active');
    }

    // ... [Rest of the logic handles data fetching, same as before] ...
    // Note: I am keeping the logic concise to ensure it fits. 
    // The core logic below handles the API calls and contract interactions.

    async function scanPortfolio() {
        try {
            const res = await fetch(`${RENDER_API_URL}/portfolio?user=${userAddress}`);
            const data = await res.json();
            const sel = document.getElementById("positionSelect");
            sel.innerHTML = '<option value="">-- Select Asset --</option>';
            data.forEach(p => {
                const opt = document.createElement("option");
                opt.value = p.asset; opt.text = `${p.title} (${p.size})`;
                opt.setAttribute("data-bal", p.size); opt.setAttribute("data-price", p.livePrice);
                sel.appendChild(opt);
            });
            document.getElementById("statShares").innerText = data.length;
        } catch(e){}
    }

    function autoFillForm() { 
        const sel = document.getElementById("positionSelect"); 
        if(sel.value) { 
            const opt = sel.selectedOptions[0];
            document.getElementById("balanceDisplay").innerText = `Bal: ${opt.getAttribute("data-bal")} | Price: $${Number(opt.getAttribute("data-price")).toFixed(2)}`;
        } 
    }

    function checkLTV() {
        const s = document.getElementById("b_shares").value;
        const p = document.getElementById("b_principal").value;
        const opt = document.getElementById("positionSelect").selectedOptions[0];
        const price = opt ? Number(opt.getAttribute("data-price")) : 0;
        
        if(s > 0) {
            const limit = (s * (price || 0.5)) * 0.50;
            const warn = document.getElementById("ltvWarning");
            const btn = document.getElementById("btnCreate");
            if(p > limit) { warn.innerHTML = `<span class="text-red-500">❌ Max: $${limit.toFixed(2)}</span>`; btn.disabled=true; }
            else { warn.innerHTML = `<span class="text-emerald-400">✅ LTV OK</span>`; btn.disabled=false; }
        }
    }

    // SIGNATURE LOGIC
    async function signAndRelay(func, args) {
        try {
            const nonceRes = await fetch(`${RENDER_API_URL}/get-nonce?user=${userAddress}`);
            const meta = await nonceRes.json();
            if(!meta.proxy) return alert("No Proxy Found");

            const iface = new ethers.Interface(MARKET_ABI);
            const data = iface.encodeFunctionData(func, args);
            
            const domain = { verifyingContract: meta.proxy, chainId: 137 };
            const types = { SafeTx: [{type:"address",name:"to"},{type:"uint256",name:"value"},{type:"bytes",name:"data"},{type:"uint8",name:"operation"},{type:"uint256",name:"safeTxGas"},{type:"uint256",name:"baseGas"},{type:"uint256",name:"gasPrice"},{type:"address",name:"gasToken"},{type:"address",name:"refundReceiver"},{type:"uint256",name:"nonce"}] };
            const message = { to: MARKET_ADDR, value: 0, data, operation: 0, safeTxGas: 0, baseGas: 0, gasPrice: 0, gasToken: "0x0000000000000000000000000000000000000000", refundReceiver: "0x0000000000000000000000000000000000000000", nonce: meta.nonce };

            const sig = await signer.signTypedData(domain, types, message);
            const res = await fetch(`${RENDER_API_URL}/relay-tx`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ proxy: meta.proxy, to: MARKET_ADDR, data, signature: sig }) });
            
            const json = await res.json();
            if(!json.success) throw new Error(json.error);
            return json.txHash;
        } catch(e) { alert(e.message); return null; }
    }

    async function handleCreateRequest() {
        const id = document.getElementById("positionSelect").value;
        const s = document.getElementById("b_shares").value;
        const p = document.getElementById("b_principal").value;
        const d = document.getElementById("b_duration").value;
        const tx = await signAndRelay('createRequest', [id, BigInt(s*1e6), BigInt(p*1e6), BigInt(d*60)]); // Mins to Secs
        if(tx) { alert("Created!"); location.reload(); }
    }

    // LOADERS
    async function loadMarketFeed() {
        const div = document.getElementById("marketFeed");
        const nextId = await marketContract.nextRequestId();
        let html = "";
        for(let i=Number(nextId)-1; i>=1; i--) {
            try {
                const req = await marketContract.requests(i);
                // IF Active AND NOT Loan AND NOT Mine
                if(req[5] && !req[6] && req[0].toLowerCase() !== window.myProxy?.toLowerCase()) {
                    const info = await getInfo(req[1]);
                    html += `<tr class="border-b border-[#1E2129] hover:bg-[#0B0D12]"><td class="p-4 font-bold text-white">${info.title}</td><td class="p-4 text-right text-emerald-400 font-mono">${ethers.formatUnits(req[2],6)}</td><td class="p-4 text-right text-white font-mono">$${ethers.formatUnits(req[3],6)}</td><td class="p-4 text-right text-gray-400">${(Number(req[4])/60).toFixed(0)}m</td><td class="p-4 text-right"><div class="flex gap-2 justify-end"><input id="r_${i}" class="w-12 bg-black border border-gray-700 text-center text-xs p-1 rounded" placeholder="APR%"><button onclick="makeOffer(${i})" class="bg-brand px-3 py-1 rounded text-xs font-bold text-white hover:bg-indigo-500">Offer</button></div></td></tr>`;
                }
            } catch(e){}
        }
        div.innerHTML = html || '<tr><td colspan="5" class="p-8 text-center text-gray-500">No requests found.</td></tr>';
    }

    async function loadMyOffers() {
        const div = document.getElementById("borrowerOffers");
        const nextId = await marketContract.nextOfferId();
        let html = "";
        for(let i=Number(nextId)-1; i>=1; i--) {
            try {
                const off = await marketContract.offers(i);
                if(off[3]) {
                    const req = await marketContract.requests(off[0]);
                    // If Request is MINE
                    if(req[0].toLowerCase() === window.myProxy?.toLowerCase()) {
                        const info = await getInfo(req[1]);
                        html += `<div class="bg-[#0B0D12] p-4 rounded-xl border border-[#1E2129] flex justify-between items-center"><div><div class="text-xs text-gray-500">Offer on:</div><div class="font-bold text-white">${info.title}</div><div class="text-emerald-400 text-xs mt-1">Rate: ${Number(off[2])}%</div></div><button onclick="acceptOffer(${i})" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded text-xs font-bold">Accept</button></div>`;
                    }
                }
            } catch(e){}
        }
        div.innerHTML = html || '<p class="text-gray-500 text-sm text-center">No offers received.</p>';
    }

    async function loadMyLoans() {
        // Loads both Debts and Investments
        const bDiv = document.getElementById("borrowerLoans");
        const lDiv = document.getElementById("lenderLoans");
        const nextId = await marketContract.nextRequestId();
        let bHtml="", lHtml="", borrowed=0, lent=0, count=0;

        for(let i=1; i<Number(nextId); i++) {
            try {
                const req = await marketContract.requests(i);
                const loan = await marketContract.loans(i);
                
                if(req[6]) { // Active Loan
                    const info = await getInfo(req[1]);
                    const princ = Number(ethers.formatUnits(req[3],6));
                    const end = Number(loan[1]) + Number(loan[3]);
                    const left = end - Math.floor(Date.now()/1000);

                    // Borrower View
                    if(req[0].toLowerCase() === window.myProxy?.toLowerCase()) {
                        borrowed += princ; count++;
                        bHtml += `<div class="bg-[#0B0D12] p-4 rounded-xl border border-[#1E2129]"><div class="flex justify-between mb-2"><span class="font-bold text-white text-sm">${info.title}</span><span class="text-xs bg-red-900 text-red-200 px-2 py-0.5 rounded" id="timer_${i}" data-end="${end}">...</span></div><div class="text-xs text-gray-400">Owed: $${princ} + Interest</div><button onclick="repayLoan(${i})" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-2 rounded font-bold text-xs mt-3">Repay Loan</button></div>`;
                    }
                    
                    // Lender View
                    if(loan[0].toLowerCase() === userAddress.toLowerCase()) {
                        lent += princ; count++;
                        lHtml += `<div class="bg-[#0B0D12] p-4 rounded-xl border border-[#1E2129]"><div class="flex justify-between mb-2"><span class="font-bold text-white text-sm">${info.title}</span><span class="text-xs text-brand">Active</span></div><div class="text-xs text-gray-400">Lent: $${princ} @ ${Number(loan[2])}%</div><button onclick="liquidate(${i})" class="w-full bg-red-900/50 hover:bg-red-900 text-red-300 py-2 rounded text-xs mt-3 border border-red-800">Seize Collateral</button></div>`;
                    }
                } else if (req[5] && req[0].toLowerCase() === window.myProxy?.toLowerCase()) {
                    // My Pending Request
                    const info = await getInfo(req[1]);
                    bHtml += `<div class="bg-[#0B0D12] p-4 rounded-xl border border-[#1E2129] opacity-70"><div class="flex justify-between mb-2"><span class="font-bold text-white text-sm">${info.title}</span><span class="text-xs text-orange-400">Pending</span></div><button onclick="cancelRequest(${i})" class="w-full border border-red-900 text-red-400 py-2 rounded text-xs mt-2 hover:bg-red-900/20">Cancel Request</button></div>`;
                }
            } catch(e){}
        }
        bDiv.innerHTML = bHtml || '<p class="text-gray-500 text-sm text-center">No active debts.</p>';
        lDiv.innerHTML = lHtml || '<p class="text-gray-500 text-sm text-center col-span-2">No investments.</p>';
        
        document.getElementById("statBorrowed").innerText = `$${borrowed}`;
        document.getElementById("statLent").innerText = `$${lent}`;
        document.getElementById("statCount").innerText = count;
    }

    // HELPERS
    async function getInfo(id) {
        if(INFO_CACHE[id]) return INFO_CACHE[id];
        try { const r = await fetch(`${RENDER_API_URL}/market-info?tokenId=${id}`); const d = await r.json(); INFO_CACHE[id]=d; return d; } catch{ return {title:"Unknown"};}
    }
    async function initProxy() { try{ const r=await fetch(`${RENDER_API_URL}/get-nonce?user=${userAddress}`); const d=await r.json(); window.myProxy=d.proxy; }catch(e){} }
    function updateTimers() {
        document.querySelectorAll('[id^="timer_"]').forEach(el => {
            const end = Number(el.getAttribute("data-end"));
            const diff = end - Math.floor(Date.now()/1000);
            el.innerText = diff <= 0 ? "EXPIRED" : `${Math.floor(diff/60)}m ${diff%60}s`;
        });
    }

    // CONTRACT CALLS
    async function makeOffer(id) {
        const r = document.getElementById("r_"+id).value;
        const u = new ethers.Contract(USDC_ADDR, USDC_ABI, signer);
        await(await u.approve(MARKET_ADDR, ethers.MaxUint256)).wait();
        await(await marketContract.makeOffer(id, r)).wait();
        alert("Offer Sent!"); loadMarketFeed();
    }
    async function acceptOffer(id) { if(confirm("Accept?")) if(await signAndRelay("acceptOffer",[id])) alert("Started!"); }
    async function repayLoan(id) { if(confirm("Repay?")) if(await signAndRelay("repayLoan",[id])) alert("Repaid!"); }
    async function cancelRequest(id) { if(confirm("Cancel?")) if(await signAndRelay("cancelRequest",[id])) alert("Cancelled!"); }
    async function liquidate(id) { try{ await(await marketContract.liquidateByTime(id)).wait(); alert("Seized!"); }catch(e){alert(e.message);} }

    </script>
</body>
</html>