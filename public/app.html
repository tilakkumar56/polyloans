<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PolyLoans | Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = { theme: { extend: { fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'], mono: ['"JetBrains Mono"', 'monospace'] }, colors: { bg: '#020408', surface: '#0B0D12', border: '#1E2129', brand: '#6366F1', brandHover: '#4F46E5' } } } }
    </script>
    <style>body { background-color: #020408; color: #E2E8F0; } .panel { background: #0B0D12; border: 1px solid #1E2129; } .input-premium { background: #050608; border: 1px solid #1E2129; color: white; transition: 0.2s; } .input-premium:focus { border-color: #6366F1; outline: none; } .btn-primary { background: #6366F1; color: white; transition: 0.2s; } .btn-primary:hover:not(:disabled) { background: #4F46E5; } .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }</style>
</head>
<body class="min-h-screen flex flex-col bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-indigo-900/20 via-[#020408] to-[#020408]">

    <nav class="h-20 border-b border-[#1E2129] flex items-center justify-between px-8 bg-[#020408]/80 backdrop-blur-md sticky top-0 z-50">
        <a href="/" class="flex items-center gap-3 text-white font-bold tracking-tight text-lg">‚ñ≤ PolyLoans <span class="text-[10px] bg-indigo-500/10 text-indigo-300 border border-indigo-500/20 px-1.5 py-0.5 rounded ml-1">APP</span></a>
        <div class="flex items-center gap-4">
            <div id="userAddr" class="hidden font-mono text-xs bg-[#0B0D12] border border-[#1E2129] px-4 py-2 rounded text-indigo-300"></div>
            <button id="btnConnect" onclick="connectWallet()" class="btn-primary px-6 py-2.5 rounded-lg text-sm font-bold">Connect Wallet</button>
        </div>
    </nav>

    <main class="flex-1 p-8 grid grid-cols-1 lg:grid-cols-12 gap-8 max-w-[1600px] mx-auto w-full">
        <section class="lg:col-span-4 space-y-6">
            <div class="panel rounded-2xl p-6">
                <div class="flex justify-between items-center mb-6"><h2 class="text-lg font-bold text-white">Borrow Liquidity</h2><span class="text-[10px] font-bold text-indigo-400 bg-indigo-900/20 px-2 py-1 rounded border border-indigo-900/50">STEP 1</span></div>
                <div class="space-y-5">
                    <div><label class="text-xs font-bold text-gray-500 mb-2 block uppercase tracking-wider">Collateral Asset</label><select id="positionSelect" onchange="autoFillForm()" class="input-premium w-full rounded-xl px-4 py-3 text-sm cursor-pointer"><option>-- Connect Wallet First --</option></select><div id="priceDisplay" class="mt-2 text-xs h-5"></div></div>
                    <input type="text" id="b_tokenId" class="hidden">
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-xs font-bold text-gray-500 mb-2 block uppercase tracking-wider">Lock Shares</label><input type="number" id="b_shares" placeholder="0.00" class="input-premium w-full rounded-xl px-4 py-3 text-sm font-mono" oninput="checkLTV()"></div>
                        <div><label class="text-xs font-bold text-gray-500 mb-2 block uppercase tracking-wider">Get USDC</label><input type="number" id="b_principal" placeholder="0.00" class="input-premium w-full rounded-xl px-4 py-3 text-sm font-mono" oninput="checkLTV()"></div>
                    </div>
                    <div id="ltvWarning" class="text-xs h-5 font-mono text-right"></div>
                    <div><label class="text-xs font-bold text-gray-500 mb-2 block uppercase tracking-wider">Duration (Days)</label><input type="number" id="b_duration" placeholder="0 (Negotiable)" value="0" class="input-premium w-full rounded-xl px-4 py-3 text-sm font-mono"></div>
                    <button id="btnCreate" onclick="handleCreateRequest()" disabled class="w-full btn-primary py-4 rounded-xl text-sm font-bold mt-2">Sign & Post Request</button>
                    <div id="b_status" class="text-center text-xs mt-3 text-gray-500 font-mono"></div>
                </div>
            </div>
            <div class="panel rounded-2xl p-6">
                <div class="flex justify-between items-center mb-4"><h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider">My Active Debts</h3><button onclick="loadActiveLoans()" class="text-xs text-indigo-400 hover:text-white transition">‚Üª</button></div>
                <div id="activeLoans" class="space-y-3"><div class="text-center py-8 text-gray-700 text-xs font-medium">No active loans</div></div>
            </div>
        </section>

        <section class="lg:col-span-8 space-y-6">
            <div class="panel rounded-2xl overflow-hidden flex flex-col h-[520px]">
                <div class="p-5 border-b border-[#1E2129] flex justify-between items-center bg-[#050608]/50"><h2 class="font-bold text-white text-sm uppercase tracking-wide flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span> Market Feed</h2><button onclick="loadMarketFeed()" class="text-xs text-gray-500 hover:text-white transition">Refresh</button></div>
                <div class="overflow-y-auto flex-1 p-0 bg-[#020408]"><table class="w-full text-left border-collapse"><thead class="sticky top-0 bg-[#0B0D12] z-10 text-[10px] text-gray-500 uppercase font-bold tracking-wider"><tr><th class="p-4 border-b border-[#1E2129]">Asset</th><th class="p-4 border-b border-[#1E2129] text-right">Collateral</th><th class="p-4 border-b border-[#1E2129] text-right">Ask (USDC)</th><th class="p-4 border-b border-[#1E2129] text-right">Duration</th><th class="p-4 border-b border-[#1E2129] text-right">Action</th></tr></thead><tbody id="marketFeed" class="text-sm divide-y divide-[#1E2129] text-gray-300"><tr><td colspan="5" class="p-16 text-center text-gray-600">Connecting...</td></tr></tbody></table></div>
            </div>
            <div class="panel rounded-2xl p-5">
                <div class="flex justify-between items-center mb-4 pb-2 border-b border-[#1E2129]"><h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Incoming Offers</h3><button onclick="loadMyOffers()" class="text-xs text-indigo-400 hover:text-white">Sync</button></div>
                <div id="myOffers" class="grid grid-cols-1 md:grid-cols-2 gap-4"><p class="text-xs text-gray-600 col-span-2 text-center py-4">No offers received.</p></div>
            </div>
        </section>
    </main>

    <script>
    // --- üöÄ CONFIGURATION ---
    const MARKET_ADDR = "0x4081877663166Ff17d3fE690f271b329a2ed58eE"; 
    const USDC_ADDR = "0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359"; // NATIVE USDC
    const RENDER_API_URL = "https://polyloans-api.onrender.com"; 

    let signer, userAddress, marketContract;
    const INFO_CACHE = {}; 

    // ABIs (Full)
    const MARKET_ABI = ["function makeOffer(uint256, uint256, uint256) external returns (uint256)","function cancelOffer(uint256) external","function requests(uint256) view returns (address, uint256, uint256, uint256, uint256, bool)","function offers(uint256) view returns (uint256, address, uint256, uint256, bool)","function activeLoans(uint256) view returns (address, address, uint256, uint256, uint256, uint256, uint256, uint256)","function nextRequestId() view returns (uint256)","function nextOfferId() view returns (uint256)","function liquidateByTime(uint256) external", "function createRequest(uint256, uint256, uint256, uint256) external returns (uint256)", "function acceptOffer(uint256) external", "function repayLoan(uint256) external"];
    const USDC_ABI = ["function approve(address, uint256) external"];

    async function connectWallet() {
        if (!window.ethereum) return alert("Install Rabby!");
        const provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();
        userAddress = await signer.getAddress();
        marketContract = new ethers.Contract(MARKET_ADDR, MARKET_ABI, signer);
        
        document.getElementById("userAddr").classList.remove("hidden");
        document.getElementById("userAddr").innerText = userAddress.slice(0,6) + "..." + userAddress.slice(-4);
        document.getElementById("btnConnect").style.display = "none";
        
        scanPortfolio();
        loadMarketFeed(); 
        loadMyOffers();
        loadActiveLoans();
        setInterval(loadActiveLoans, 2000); 
    }

    // --- üîê SECURITY CORE: SIGN & RELAY ---
    async function signAndRelay(funcName, args) {
        try {
            // 1. Get Nonce from Server
            const metaRes = await fetch(`${RENDER_API_URL}/get-nonce?user=${userAddress}`);
            const meta = await metaRes.json();
            if(!meta.proxy) throw new Error("No Proxy found");
            
            // 2. Prepare Data
            const iface = new ethers.Interface(MARKET_ABI);
            const data = iface.encodeFunctionData(funcName, args);
            
            // 3. Request Signature (EIP-712)
            const domain = { verifyingContract: meta.proxy, chainId: 137 };
            const types = { SafeTx: [{type:"address",name:"to"},{type:"uint256",name:"value"},{type:"bytes",name:"data"},{type:"uint8",name:"operation"},{type:"uint256",name:"safeTxGas"},{type:"uint256",name:"baseGas"},{type:"uint256",name:"gasPrice"},{type:"address",name:"gasToken"},{type:"address",name:"refundReceiver"},{type:"uint256",name:"nonce"}] };
            const message = { to: MARKET_ADDR, value: 0, data: data, operation: 0, safeTxGas: 0, baseGas: 0, gasPrice: 0, gasToken: "0x0000000000000000000000000000000000000000", refundReceiver: "0x0000000000000000000000000000000000000000", nonce: meta.nonce };

            const signature = await signer.signTypedData(domain, types, message);
            
            // 4. Send to Relayer
            const res = await fetch(`${RENDER_API_URL}/relay-tx`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ proxy: meta.proxy, to: MARKET_ADDR, data, signature })
            });
            const result = await res.json();
            if(!result.success) throw new Error(result.error);
            return result.txHash;

        } catch(e) {
            console.error(e);
            alert("‚ùå Transaction Failed: " + e.message);
            return null;
        }
    }

    // --- ACTIONS ---
    async function handleCreateRequest() {
        const id = document.getElementById("b_tokenId").value;
        const shares = document.getElementById("b_shares").value; 
        const principal = document.getElementById("b_principal").value; 
        const duration = document.getElementById("b_duration").value || 0;
        
        const status = document.getElementById("b_status");
        status.innerText = "‚è≥ Please Sign in Wallet...";
        
        const tx = await signAndRelay('createRequest', [id, BigInt(Math.floor(shares*1e6)), BigInt(Math.floor(principal*1e6)), BigInt(duration*86400)]);
        if(tx) { status.innerHTML = `<span class="text-emerald-400">‚úÖ Success!</span>`; setTimeout(loadMarketFeed, 4000); }
        else { status.innerText = "‚ùå Cancelled / Failed"; }
    }

    async function handleAcceptOffer(offerId) {
        if(!confirm("Accept Offer?")) return;
        if(await signAndRelay('acceptOffer', [offerId])) { alert("‚úÖ Deal Active!"); location.reload(); }
    }

    async function handleRepay(requestId) {
        if(!confirm("Repay Loan?")) return;
        if(await signAndRelay('repayLoan', [requestId])) { alert("‚úÖ Repaid!"); location.reload(); }
    }

    async function handleCancel(offerId) {
        if(!confirm("Cancel Offer?")) return;
        if(await signAndRelay('cancelOffer', [offerId])) { alert("‚úÖ Cancelled!"); location.reload(); }
    }

    // --- HELPERS (Scan, Feed) ---
    async function scanPortfolio() {
        const select = document.getElementById("positionSelect");
        select.innerHTML = '<option>üîç Scanning...</option>';
        try {
            const res = await fetch(`${RENDER_API_URL}/portfolio?user=${userAddress}`);
            const data = await res.json();
            if (data.length === 0) { select.innerHTML = '<option>‚ùå No shares found</option>'; return; }
            select.innerHTML = '<option value="">-- Select --</option>';
            data.forEach(p => {
                const opt = document.createElement("option");
                opt.value = p.asset || p.asset_id;
                opt.setAttribute("data-balance", p.size);
                opt.setAttribute("data-price", p.livePrice ? Number(p.livePrice) : 0);
                INFO_CACHE[opt.value] = { title: p.title, link: p.slug ? `https://polymarket.com/event/${p.slug}` : "#" };
                opt.text = `${p.title} (${p.outcome})`;
                select.appendChild(opt);
            });
        } catch(e) { select.innerHTML = '<option>‚ö†Ô∏è Error Scanning</option>'; }
    }

    function autoFillForm() { 
        const sel = document.getElementById("positionSelect");
        const opt = sel.options[sel.selectedIndex];
        const display = document.getElementById("priceDisplay");
        const btn = document.getElementById("btnCreate");
        if(opt.value) {
            document.getElementById("b_tokenId").value = opt.value;
            const price = Number(opt.getAttribute("data-price"));
            display.innerHTML = price < 0.90 ? `<span class="text-red-500">‚ö†Ô∏è Low Price ($${price.toFixed(2)})</span>` : `<span class="text-emerald-400">‚úÖ Value: $${price.toFixed(2)}</span>`;
            btn.disabled = false;
        }
    }

    function checkLTV() {
        const shares = Number(document.getElementById("b_shares").value);
        const principal = Number(document.getElementById("b_principal").value);
        const warning = document.getElementById("ltvWarning");
        const opt = document.getElementById("positionSelect").selectedOptions[0];
        const price = opt ? Number(opt.getAttribute("data-price")) : 0;
        
        if (shares > 0) {
            const maxLoan = (shares * (price || 1)) * 0.50; // 50% LTV
            if (principal > maxLoan) {
                warning.innerHTML = `<span class="text-red-500">‚ùå >50% LTV (Limit: $${maxLoan.toFixed(2)})</span>`;
                document.getElementById("btnCreate").disabled = true;
            } else {
                warning.innerHTML = `<span class="text-emerald-400">‚úÖ LTV OK</span>`;
                document.getElementById("btnCreate").disabled = false;
            }
        }
    }

    async function getMarketInfo(tokenId) {
        if(INFO_CACHE[tokenId]) return INFO_CACHE[tokenId];
        try {
            const res = await fetch(`${RENDER_API_URL}/market-info?tokenId=${tokenId}`);
            const data = await res.json();
            return { title: data.title || "Unknown Market", link: data.slug ? `https://polymarket.com/event/${data.slug}` : "#" };
        } catch(e) { return { title: "Error", link: "#" }; }
    }

    async function loadMarketFeed() {
        const tbody = document.getElementById("marketFeed");
        try {
            const nextId = await marketContract.nextRequestId();
            let html = "";
            for (let i = Number(nextId) - 1; i >= 1; i--) {
                const req = await marketContract.requests(i);
                if (req[5] === true) {
                    const principal = ethers.formatUnits(req[3], 6);
                    const shares = ethers.formatUnits(req[2], 6);
                    const days = Number(req[4]) > 0 ? (Number(req[4])/86400).toFixed(1) + " Days" : "Flex";
                    const info = await getMarketInfo(req[1]);
                    html += `<tr class="hover:bg-[#1E2129]/50 border-b border-[#1E2129]"><td class="p-4"><div class="font-bold text-gray-200 text-xs">${info.title}</div><a href="${info.link}" target="_blank" class="text-brand text-[10px]">View ‚Üó</a></td><td class="p-4 text-right font-mono text-emerald-400 text-xs">${shares}</td><td class="p-4 text-right font-mono text-white text-xs">$${principal}</td><td class="p-4 text-right text-gray-500 text-xs">${days}</td><td class="p-4 text-right flex justify-end gap-2"><input type="number" id="rate_${i}" placeholder="%" class="input-premium w-14 px-1 text-center text-xs rounded"><button class="bg-brand hover:bg-brandHover text-white px-3 py-1 rounded text-xs" onclick="makeOffer(${i})">Offer</button></td></tr>`;
                }
            }
            tbody.innerHTML = html || '<tr><td colspan="5" class="p-12 text-center text-gray-600 text-xs italic">No requests.</td></tr>';
        } catch(e) { }
    }

    async function makeOffer(reqId) {
        // Lenders pay their own gas, so no signature needed here, just standard wallet tx
        const rate = Number(document.getElementById("rate_" + reqId).value) * 100;
        const usdc = new ethers.Contract(USDC_ADDR, USDC_ABI, signer);
        await (await usdc.approve(MARKET_ADDR, ethers.MaxUint256)).wait();
        await (await marketContract.makeOffer(reqId, rate, 0)).wait(); 
        alert("‚úÖ Offer Sent!");
        loadMyOffers(); 
    }

    async function loadMyOffers() {
        const div = document.getElementById("myOffers");
        try {
            const nextId = await marketContract.nextOfferId();
            let html = "";
            for (let i = Number(nextId) - 1; i >= 1; i--) {
                const offer = await marketContract.offers(i);
                if (offer[4] === true) {
                    const req = await marketContract.requests(offer[0]);
                    const info = await getMarketInfo(req[1]);
                    const rate = Number(offer[2]) / 100;
                    let action = "";
                    if (offer[1].toLowerCase() === userAddress.toLowerCase()) action = `<button class="w-full bg-red-900/30 text-red-400 py-1 rounded text-xs border border-red-900/50" onclick="handleCancel(${i})">Cancel</button>`;
                    else if (req[0].toLowerCase() === "0x06CF8B375BD12E7256F8Da3e695857226b2b36d7".toLowerCase()) action = `<button class="w-full bg-emerald-600 text-white py-1 rounded text-xs font-bold" onclick="handleAcceptOffer(${i})">Accept</button>`;
                    
                    if(action) html += `<div class="bg-[#0B0D12] p-4 rounded-xl border border-[#1E2129]"><div class="flex justify-between mb-2"><span class="text-xs text-brand">Offer #${i}</span><span class="text-xs font-bold text-emerald-400">${rate}% APR</span></div><p class="text-xs text-gray-400 truncate mb-3">${info.title}</p>${action}</div>`;
                }
            }
            div.innerHTML = html || "<p class='text-xs text-gray-600 text-center py-4 col-span-2'>No offers.</p>";
        } catch(e) {}
    }

    async function loadActiveLoans() {
        const div = document.getElementById("activeLoans");
        try {
            const nextId = await marketContract.nextRequestId();
            let html = "";
            for (let i = 1; i < Number(nextId); i++) {
                const loan = await marketContract.activeLoans(i);
                if (loan[6] > 0n && (loan[0].toLowerCase() === "0x06CF8B375BD12E7256F8Da3e695857226b2b36d7".toLowerCase() || loan[1].toLowerCase() === userAddress.toLowerCase())) {
                    const info = await getMarketInfo(loan[2]);
                    const principal = Number(ethers.formatUnits(loan[4], 6));
                    let action = "";
                    if(loan[0].toLowerCase() === "0x06CF8B375BD12E7256F8Da3e695857226b2b36d7".toLowerCase()) action = `<button class="text-xs text-emerald-400 hover:text-white ml-auto" onclick="handleRepay(${i})">Repay</button>`;
                    html += `<div class="flex justify-between items-center bg-[#0B0D12] p-3 rounded border border-[#1E2129]"><div><div class="text-xs font-bold text-gray-300 truncate w-32">${info.title}</div><div class="text-[10px] text-gray-500">Loan #${i} | $${principal}</div></div>${action}</div>`;
                }
            }
            div.innerHTML = html || "<div class='text-center py-6 text-gray-600 text-xs italic'>No active loans</div>";
        } catch(e) {}
    }
    </script>
</body>
</html>