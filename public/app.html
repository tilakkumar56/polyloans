<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PolyLoans | Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = { theme: { extend: { fontFamily: { sans: ['"Plus Jakarta Sans"'], mono: ['"JetBrains Mono"'] }, colors: { bg: '#020408', surface: '#0B0D12', border: '#1E2129', brand: '#6366F1' } } } }
    </script>
    <style>
        body { background-color: #020408; color: #E2E8F0; }
        .panel { background: #0B0D12; border: 1px solid #1E2129; }
        .input-prem { background: #050608; border: 1px solid #1E2129; color: white; }
        .btn-brand { background: #6366F1; color: white; } .btn-brand:hover { background: #4F46E5; }
        .hidden-tab { display: none !important; }
        .tab-active { border-bottom: 2px solid #6366F1; color: white; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <nav class="h-16 border-b border-[#1E2129] flex items-center justify-between px-6 bg-[#020408]">
        <div class="flex items-center gap-8">
            <span class="font-bold text-lg text-white">PolyLoans <span class="text-[10px] text-brand bg-brand/10 px-1 rounded">BETA</span></span>
            <div id="navTabs" class="hidden flex gap-4 text-sm font-medium h-16 items-end pb-4">
                <button onclick="switchTab('overview')" id="tab-overview" class="tab-btn tab-active">Overview</button>
                <button onclick="switchTab('borrow')" id="tab-borrow" class="tab-btn">Borrow</button>
                <button onclick="switchTab('lend')" id="tab-lend" class="tab-btn">Lend</button>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div id="userAddr" class="hidden font-mono text-xs bg-[#0B0D12] border border-[#1E2129] px-4 py-2 rounded text-indigo-300"></div>
            <button id="btnConnect" onclick="connectWallet()" class="btn-brand px-6 py-2.5 rounded-lg text-sm font-bold">Connect Wallet</button>
        </div>
    </nav>

    <main class="p-6 max-w-7xl mx-auto w-full">

        <!-- 1. OVERVIEW -->
        <div id="view-overview" class="space-y-6">
            <h2 class="text-xl font-bold">Dashboard</h2>
            <div class="grid grid-cols-4 gap-6">
                <div class="panel p-6 rounded-xl"><div class="text-xs text-gray-500 uppercase">My Debt</div><div class="text-2xl font-bold text-red-400" id="statBorrowed">$0.00</div></div>
                <div class="panel p-6 rounded-xl"><div class="text-xs text-gray-500 uppercase">My Investments</div><div class="text-2xl font-bold text-emerald-400" id="statLent">$0.00</div></div>
                <div class="panel p-6 rounded-xl"><div class="text-xs text-gray-500 uppercase">Active Deals</div><div class="text-2xl font-bold text-white" id="statCount">0</div></div>
                <div class="panel p-6 rounded-xl"><div class="text-xs text-gray-500 uppercase">Positions</div><div class="text-2xl font-bold text-brand" id="statShares">0</div></div>
            </div>
        </div>

        <!-- 2. BORROW -->
        <div id="view-borrow" class="hidden-tab grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-4 panel rounded-xl p-6 space-y-4">
                <h2 class="font-bold">New Request</h2>
                
                <div>
                    <label class="text-xs text-gray-500 block mb-1">Select Asset</label>
                    <select id="positionSelect" onchange="autoFillForm()" class="input-prem w-full rounded p-2 text-sm"></select>
                    <div id="balanceDisplay" class="text-xs text-brand mt-1 h-4"></div>
                </div>

                <!-- FIXED: Ensure ID is present -->
                <input type="text" id="b_tokenId" class="hidden">

                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs text-gray-500 block mb-1">Lock Shares</label><input type="number" id="b_shares" class="input-prem w-full rounded p-2 text-sm" oninput="checkLTV()"></div>
                    <div><label class="text-xs text-gray-500 block mb-1">Get USDC</label><input type="number" id="b_principal" class="input-prem w-full rounded p-2 text-sm" oninput="checkLTV()"></div>
                </div>
                <div id="ltvWarning" class="text-xs font-mono text-right h-4"></div>
                
                <div>
                    <label class="text-xs text-gray-500 block mb-1">Duration (Minutes)</label>
                    <input type="number" id="b_duration" class="input-prem w-full rounded p-2 text-sm" placeholder="e.g. 60">
                </div>

                <button onclick="handleCreateRequest()" id="btnCreate" disabled class="w-full btn-brand py-3 rounded font-bold text-sm">Sign & Post</button>
                <div id="b_status" class="text-center text-xs mt-2 text-gray-500"></div>
            </div>

            <div class="lg:col-span-8 space-y-6">
                <div class="panel rounded-xl p-6"><h2 class="font-bold mb-4">Incoming Offers</h2><div id="borrowerOffers" class="space-y-2"></div></div>
                <div class="panel rounded-xl p-6"><h2 class="font-bold mb-4">Active Debts</h2><div id="borrowerLoans" class="space-y-2"></div></div>
            </div>
        </div>

        <!-- 3. LEND -->
        <div id="view-lend" class="hidden-tab space-y-6">
            <div class="panel rounded-xl overflow-hidden p-4"><h2 class="font-bold mb-4">Market Feed</h2><div id="marketFeed" class="space-y-2"></div></div>
            <div class="panel rounded-xl p-6"><h2 class="font-bold mb-4">Active Investments</h2><div id="lenderLoans" class="space-y-2"></div></div>
        </div>
    </main>

    <script>
    // ⬇️ UPDATE AFTER DEPLOY
    const MARKET_ADDR = "0x59B3a47dBe8B251eB14E57509A15Ed829065B91e"; 
    const USDC_ADDR = "0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359"; 
    const RENDER_API_URL = "https://polyloans-api.onrender.com"; 

    let signer, userAddress, marketContract, myProxy;
    const INFO_CACHE = {}; 

    // ABIs
    const MARKET_ABI = ["function createRequest(uint256,uint256,uint256,uint256) external returns (uint256)","function makeOffer(uint256,uint256,uint256) external returns (uint256)","function acceptOffer(uint256) external","function repayLoan(uint256) external","function cancelRequest(uint256) external","function requestExtension(uint256,uint256) external","function acceptExtension(uint256) external","function buyoutLoan(uint256) external","function liquidateByTime(uint256) external","function requests(uint256) view returns (address, uint256, uint256, uint256, uint256, bool, bool)","function loans(uint256) view returns (address, uint256, uint256, uint256)","function offers(uint256) view returns (uint256, address, uint256, bool)","function extensions(uint256) view returns (bool, uint256, uint256)","function nextRequestId() view returns (uint256)","function nextOfferId() view returns (uint256)"];
    const USDC_ABI = ["function approve(address, uint256) external"];

    async function connectWallet() {
        // WALLET FIX: Handle conflicts gracefully
        let ethProvider = window.ethereum;
        if (!ethProvider) return alert("Install Rabby!");
        
        // Prefer Rabby if multiple are present
        if (window.ethereum.providers?.length) {
            ethProvider = window.ethereum.providers.find(p => p.isRabby) || window.ethereum.providers[0];
        }

        const provider = new ethers.BrowserProvider(ethProvider);
        try {
            await provider.send("eth_requestAccounts", []);
            try { await ethProvider.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0x89' }] }); } catch(e){}

            signer = await provider.getSigner();
            userAddress = await signer.getAddress();
            marketContract = new ethers.Contract(MARKET_ADDR, MARKET_ABI, signer);
            
            document.getElementById("userAddr").innerText = userAddress.slice(0,6)+"..."+userAddress.slice(-4);
            document.getElementById("userAddr").classList.remove("hidden");
            document.getElementById("btnConnect").style.display = "none";
            document.getElementById("navTabs").classList.remove("hidden");
            
            switchTab('overview');
            await initProxy();
            scanPortfolio(); loadMarketFeed(); loadMyOffers(); loadMyLoans();
            setInterval(loadMyLoans, 3000);

        } catch(e) { console.error(e); alert("Connection Error: " + e.message); }
    }

    function switchTab(t) {
        ['overview','borrow','lend'].forEach(v => document.getElementById(`view-${v}`).classList.add('hidden-tab'));
        document.getElementById(`view-${t}`).classList.remove('hidden-tab');
    }

    async function scanPortfolio() {
        const select = document.getElementById("positionSelect");
        try {
            const res = await fetch(`${RENDER_API_URL}/portfolio?user=${userAddress}`);
            const data = await res.json();
            if (data.length === 0) { select.innerHTML = '<option>No assets found</option>'; return; }
            select.innerHTML = '<option value="">-- Select Asset --</option>';
            data.forEach(p => {
                const opt = document.createElement("option");
                opt.value = p.asset; opt.setAttribute("data-bal", p.size); opt.setAttribute("data-price", p.livePrice);
                opt.text = `${p.title} (${p.outcome})`; select.appendChild(opt);
            });
            document.getElementById("statShares").innerText = data.length;
        } catch(e) {}
    }

    function autoFillForm() {
        const sel = document.getElementById("positionSelect");
        const opt = sel.selectedOptions[0];
        // FIX: Ensure b_tokenId exists
        if(opt.value) {
            const idInput = document.getElementById("b_tokenId");
            if(idInput) idInput.value = opt.value;
            document.getElementById("balanceDisplay").innerText = `Bal: ${opt.getAttribute("data-bal")} | $${Number(opt.getAttribute("data-price")).toFixed(2)}`;
        }
    }

    // SIGNATURE LOGIC
    async function signAndRelay(func, args) {
        try {
            const nonceRes = await fetch(`${RENDER_API_URL}/get-nonce?user=${userAddress}`);
            const meta = await nonceRes.json();
            if(!meta.proxy) return alert("No Proxy Found");

            const iface = new ethers.Interface(MARKET_ABI);
            const data = iface.encodeFunctionData(func, args);
            const domain = { verifyingContract: meta.proxy, chainId: 137 };
            const types = { SafeTx: [{type:"address",name:"to"},{type:"uint256",name:"value"},{type:"bytes",name:"data"},{type:"uint8",name:"operation"},{type:"uint256",name:"safeTxGas"},{type:"uint256",name:"baseGas"},{type:"uint256",name:"gasPrice"},{type:"address",name:"gasToken"},{type:"address",name:"refundReceiver"},{type:"uint256",name:"nonce"}] };
            const message = { to: MARKET_ADDR, value: 0, data, operation: 0, safeTxGas: 0, baseGas: 0, gasPrice: 0, gasToken: "0x0000000000000000000000000000000000000000", refundReceiver: "0x0000000000000000000000000000000000000000", nonce: meta.nonce };

            const sig = await signer.signTypedData(domain, types, message);
            const res = await fetch(`${RENDER_API_URL}/relay-tx`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ proxy: meta.proxy, to: MARKET_ADDR, data, signature: sig }) });
            
            const json = await res.json();
            if(!json.success) throw new Error(json.error);
            return json.txHash;
        } catch(e) { alert("Error: " + e.message); return null; }
    }

    // HELPERS & LOADERS (Same as before)
    function checkLTV() { const s = Number(document.getElementById("b_shares").value); const p = Number(document.getElementById("b_principal").value); const opt = document.getElementById("positionSelect").selectedOptions[0]; const price = opt ? Number(opt.getAttribute("data-price")) : 0.5; const limit = s * price * 0.5; const btn = document.getElementById("btnCreate"); if(p > limit) { document.getElementById("ltvWarning").innerText = `Max: $${limit.toFixed(2)}`; btn.disabled=true; } else { document.getElementById("ltvWarning").innerText = "LTV OK"; btn.disabled=false; } }
    async function handleCreateRequest() { const id = document.getElementById("b_tokenId").value; const s = document.getElementById("b_shares").value; const p = document.getElementById("b_principal").value; const d = document.getElementById("b_duration").value; const tx = await signAndRelay('createRequest', [id, BigInt(s*1e6), BigInt(p*1e6), BigInt(d*60)]); if(tx) { alert("Created!"); location.reload(); } }
    async function getInfo(id) { if(INFO_CACHE[id]) return INFO_CACHE[id]; try { const r = await fetch(`${RENDER_API_URL}/market-info?tokenId=${id}`); const d = await r.json(); INFO_CACHE[id]=d; return d; } catch{ return {title:"Unknown"};} }
    async function initProxy() { try{ const r=await fetch(`${RENDER_API_URL}/get-nonce?user=${userAddress}`); const d=await r.json(); window.myProxy=d.proxy; }catch(e){} }
    async function loadMarketFeed() { const div = document.getElementById("marketFeed"); const nextId = await marketContract.nextRequestId(); let html = ""; for(let i=Number(nextId)-1; i>=1; i--) { try { const req = await marketContract.requests(i); if(req[5] && !req[6] && req[0].toLowerCase() !== window.myProxy?.toLowerCase()) { const info = await getInfo(req[1]); html += `<div class="p-3 border border-gray-800 rounded bg-[#050608]"><div class="font-bold text-white">${info.title}</div><div class="text-xs text-gray-500">Ask: $${ethers.formatUnits(req[3],6)} | Dur: ${(Number(req[4])/60).toFixed(0)}m</div><div class="flex gap-2 mt-2"><input id="rate_${i}" placeholder="APR%" class="w-12 bg-black border border-gray-700 text-xs p-1 rounded"><button onclick="makeOffer(${i})" class="bg-blue-600 px-2 py-1 text-xs rounded text-white">Offer</button></div></div>`; } } catch(e){} } div.innerHTML = html || "No requests."; }
    async function loadMyOffers() { const div = document.getElementById("borrowerOffers"); const nextId = await marketContract.nextOfferId(); let html = ""; for(let i=Number(nextId)-1; i>=1; i--) { try { const off = await marketContract.offers(i); if(off[3]) { const req = await marketContract.requests(off[0]); if(req[0].toLowerCase() === window.myProxy?.toLowerCase() && req[5]) { const info = await getInfo(req[1]); html += `<div class="p-3 border border-gray-800 rounded bg-[#050608]"><div class="font-bold text-white">${info.title}</div><div class="text-xs text-green-400">Rate: ${Number(off[2])}%</div><button onclick="handleAcceptOffer(${i})" class="mt-2 bg-green-600 px-3 py-1 rounded text-xs text-white">Accept</button></div>`; } } } catch(e){} } div.innerHTML = html || "No offers."; }
    async function loadMyLoans() { const bDiv = document.getElementById("borrowerLoans"); const lDiv = document.getElementById("lenderLoans"); const nextId = await marketContract.nextRequestId(); let bHtml="", lHtml="", borrowed=0, lent=0, count=0; for(let i=1; i<Number(nextId); i++) { try { const req = await marketContract.requests(i); const loan = await marketContract.loans(i); if(req[6]) { const info = await getInfo(req[1]); const princ = Number(ethers.formatUnits(req[3],6)); if(req[0].toLowerCase() === window.myProxy?.toLowerCase()) { borrowed+=princ; count++; bHtml += `<div class="p-3 bg-[#0B0D12] rounded border border-gray-800"><div class="font-bold text-sm">${info.title}</div><button onclick="handleRepay(${i})" class="w-full bg-blue-600 text-xs py-1 rounded mt-2">Repay</button></div>`; } if(loan[0].toLowerCase() === userAddress.toLowerCase()) { lent+=princ; count++; lHtml += `<div class="p-3 bg-[#0B0D12] rounded border border-gray-800"><div class="font-bold text-sm">${info.title}</div><button onclick="handleLiquidate(${i})" class="w-full bg-red-900 text-xs py-1 rounded mt-2">Seize</button></div>`; } } } catch(e){} } document.getElementById("borrowerLoans").innerHTML = bHtml || "No debts"; document.getElementById("lenderLoans").innerHTML = lHtml || "No investments"; document.getElementById("statBorrowed").innerText = `$${borrowed}`; document.getElementById("statLent").innerText = `$${lent}`; document.getElementById("statCount").innerText = count; }
    async function makeOffer(id) { const r=document.getElementById("rate_"+id).value; const u=new ethers.Contract(USDC_ADDR,USDC_ABI,signer); await(await u.approve(MARKET_ADDR,ethers.MaxUint256)).wait(); await(await marketContract.makeOffer(id,Number(r))).wait(); alert("Offer Sent!"); loadMarketFeed(); }
    async function handleAcceptOffer(id) { if(confirm("Accept?")) if(await signAndRelay("acceptOffer",[id])) alert("Started!"); }
    async function handleRepay(id) { if(confirm("Repay?")) if(await signAndRelay("repayLoan",[id])) alert("Repaid!"); }
    async function handleLiquidate(id) { try{ await(await marketContract.liquidateByTime(id)).wait(); alert("Seized!"); }catch(e){alert(e.message);} }
    </script>
</body>
</html>