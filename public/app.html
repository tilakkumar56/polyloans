<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <title>PolyLoans | DeFi Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = { theme: { extend: { fontFamily: { sans: ['"Plus Jakarta Sans"'], mono: ['"JetBrains Mono"'] }, colors: { bg: '#020408', surface: '#0B0D12', border: '#1E2129', brand: '#6366F1' } } } }
    </script>
    <style>
        body { background-color: #020408; color: #E2E8F0; }
        .panel { background: #0B0D12; border: 1px solid #1E2129; }
        .input-prem { background: #050608; border: 1px solid #1E2129; color: white; }
        .btn-brand { background: #6366F1; color: white; } .btn-brand:hover { background: #4F46E5; }
        .tab-btn { border-bottom: 2px solid transparent; color: #6B7280; }
        .tab-active { border-bottom: 2px solid #6366F1; color: white; }
        .hidden-tab { display: none; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <nav class="h-16 border-b border-[#1E2129] flex items-center justify-between px-6 bg-[#020408]">
        <div class="flex items-center gap-8">
            <span class="font-bold text-lg text-white">PolyLoans <span class="text-[10px] text-brand bg-brand/10 px-1 rounded">BETA</span></span>
            <div id="navTabs" class="hidden flex gap-6 text-sm font-medium h-16 items-end pb-4">
                <button onclick="switchTab('overview')" id="tab-overview" class="tab-btn tab-active">Overview</button>
                <button onclick="switchTab('borrower')" id="tab-borrower" class="tab-btn">Borrower</button>
                <button onclick="switchTab('lender')" id="tab-lender" class="tab-btn">Lender</button>
            </div>
        </div>
        <button id="btnConnect" onclick="connectWallet()" class="btn-brand px-4 py-2 rounded text-sm font-bold">Connect Wallet</button>
        <div id="userAddr" class="hidden font-mono text-xs text-gray-400"></div>
    </nav>

    <main class="p-6 max-w-7xl mx-auto w-full">

        <div id="view-overview" class="space-y-6">
            <div class="grid grid-cols-3 gap-6">
                <div class="panel p-6 rounded-xl">
                    <div class="text-gray-500 text-xs uppercase">Total Borrowed</div>
                    <div class="text-2xl font-bold text-white mt-1" id="statBorrowed">$0.00</div>
                </div>
                <div class="panel p-6 rounded-xl">
                    <div class="text-gray-500 text-xs uppercase">Active Loans</div>
                    <div class="text-2xl font-bold text-white mt-1" id="statCount">0</div>
                </div>
                <div class="panel p-6 rounded-xl">
                    <div class="text-gray-500 text-xs uppercase">Share Balance</div>
                    <div class="text-2xl font-bold text-brand mt-1" id="statShares">0</div>
                </div>
            </div>
            
            <div class="panel rounded-xl p-6">
                <h3 class="font-bold text-white mb-4">My Activity</h3>
                <div id="historyList" class="text-sm text-gray-500">Connecting to graph...</div>
            </div>
        </div>

        <div id="view-borrower" class="hidden-tab grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-4 panel rounded-xl p-6 space-y-4">
                <h2 class="font-bold text-white">New Loan Request</h2>
                
                <div>
                    <label class="text-xs text-gray-500 block mb-1">Select Asset</label>
                    <select id="positionSelect" onchange="autoFillForm()" class="input-prem w-full rounded p-2 text-sm"></select>
                    <div id="balanceDisplay" class="text-xs text-brand mt-1 h-4"></div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs text-gray-500 block mb-1">Shares</label><input type="number" id="b_shares" class="input-prem w-full rounded p-2 text-sm" oninput="checkLTV()"></div>
                    <div><label class="text-xs text-gray-500 block mb-1">USDC Needed</label><input type="number" id="b_principal" class="input-prem w-full rounded p-2 text-sm" oninput="checkLTV()"></div>
                </div>
                
                <div id="ltvWarning" class="text-xs font-mono text-right h-4"></div>

                <div>
                    <label class="text-xs text-gray-500 block mb-1">Duration (Minutes for Test)</label>
                    <input type="number" id="b_duration" class="input-prem w-full rounded p-2 text-sm" placeholder="e.g. 60">
                </div>

                <button id="btnCreate" onclick="handleCreateRequest()" disabled class="w-full btn-brand py-3 rounded font-bold text-sm">Sign Request</button>
            </div>

            <div class="lg:col-span-8 panel rounded-xl p-6">
                <h2 class="font-bold text-white mb-4">My Active Debts</h2>
                <div id="borrowerLoans" class="space-y-3"></div>
            </div>
        </div>

        <div id="view-lender" class="hidden-tab space-y-6">
            <div class="panel rounded-xl overflow-hidden">
                <div class="p-4 border-b border-[#1E2129] flex justify-between bg-[#050608]">
                    <h2 class="font-bold text-white">Market Feed</h2>
                    <button onclick="loadMarketFeed()" class="text-xs text-brand">Refresh</button>
                </div>
                <table class="w-full text-left text-sm text-gray-300">
                    <thead class="bg-[#0B0D12] text-xs uppercase text-gray-500">
                        <tr><th class="p-4">Market</th><th class="p-4 text-right">Shares</th><th class="p-4 text-right">Ask</th><th class="p-4 text-right">Duration</th><th class="p-4 text-right">Offers</th><th class="p-4 text-right">Action</th></tr>
                    </thead>
                    <tbody id="marketFeed"></tbody>
                </table>
            </div>
        </div>

    </main>

    <script>
    // ‚¨áÔ∏è UPDATE THIS ADDRESS ‚¨áÔ∏è
    const MARKET_ADDR = "0xE754F567272478B14f4dBc360a0F25B1DFa52dA3"; 
    const USDC_ADDR = "0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359"; 
    const RENDER_API_URL = "https://polyloans-api.onrender.com"; 

    let signer, userAddress, marketContract;
    
    // Updated ABI
    const MARKET_ABI = [
        "function createRequest(uint256, uint256, uint256, uint256) external returns (uint256)",
        "function cancelRequest(uint256) external",
        "function makeOffer(uint256, uint256) external returns (uint256)",
        "function acceptOffer(uint256) external",
        "function repayLoan(uint256) external",
        "function liquidateByTime(uint256) external",
        "function requestExtension(uint256, uint256) external",
        "function acceptExtension(uint256) external",
        "function buyoutLoan(uint256) external",
        "function requests(uint256) view returns (address, uint256, uint256, uint256, uint256, bool, bool)",
        "function loans(uint256) view returns (address, uint256, uint256, uint256)",
        "function nextRequestId() view returns (uint256)",
        "function activeLoans(uint256) view returns (address, address, uint256, uint256, uint256, uint256, uint256, uint256)" // Legacy helper if exists, else use mappings
    ];

    async function connectWallet() {
        if (!window.ethereum) return alert("Install Rabby!");
        await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0x89' }] });
        const provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();
        userAddress = await signer.getAddress();
        marketContract = new ethers.Contract(MARKET_ADDR, MARKET_ABI, signer);
        
        document.getElementById("userAddr").innerText = userAddress.slice(0,6)+"..."+userAddress.slice(-4);
        document.getElementById("btnConnect").style.display = "none";
        document.getElementById("navTabs").classList.remove("hidden");
        
        switchTab('overview');
        scanPortfolio();
        loadMarketFeed();
        loadMyLoans();
        setInterval(updateTimers, 1000);
    }

    function switchTab(tab) {
        ['overview','borrower','lender'].forEach(t => document.getElementById(`view-${t}`).classList.add('hidden-tab'));
        document.getElementById(`view-${tab}`).classList.remove('hidden-tab');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
        document.getElementById(`tab-${tab}`).classList.add('tab-active');
    }

    async function scanPortfolio() {
        const select = document.getElementById("positionSelect");
        try {
            const res = await fetch(`${RENDER_API_URL}/portfolio?user=${userAddress}`);
            const data = await res.json();
            if (data.length === 0) { select.innerHTML = '<option>No assets found</option>'; return; }
            select.innerHTML = '<option value="">-- Select Asset --</option>';
            data.forEach(p => {
                const opt = document.createElement("option");
                opt.value = p.asset;
                opt.setAttribute("data-bal", p.size);
                opt.setAttribute("data-price", p.livePrice);
                opt.text = `${p.title} (${p.outcome})`;
                select.appendChild(opt);
            });
            // Update Overview Stat
            document.getElementById("statShares").innerText = data.length + " Positions";
        } catch(e) {}
    }

    function autoFillForm() {
        const sel = document.getElementById("positionSelect");
        const opt = sel.selectedOptions[0];
        if(opt.value) {
            document.getElementById("b_tokenId").value = opt.value;
            document.getElementById("balanceDisplay").innerText = `Available: ${opt.getAttribute("data-bal")} Shares`;
        }
    }

    function checkLTV() {
        const shares = Number(document.getElementById("b_shares").value);
        const principal = Number(document.getElementById("b_principal").value);
        const opt = document.getElementById("positionSelect").selectedOptions[0];
        const price = opt ? Number(opt.getAttribute("data-price")) : 0;
        const btn = document.getElementById("btnCreate");
        
        if (shares > 0) {
            const val = shares * (price || 0.5); // Fallback price
            const limit = val * 0.50; // üî• 50% LTV HARDCODED
            const warning = document.getElementById("ltvWarning");
            
            if (principal > limit) {
                warning.innerHTML = `<span class="text-red-500">‚ùå Max Loan: $${limit.toFixed(2)} (50% LTV)</span>`;
                btn.disabled = true;
            } else {
                warning.innerHTML = `<span class="text-emerald-400">‚úÖ LTV OK</span>`;
                btn.disabled = false;
            }
        }
    }

    // --- TRANSACTIONS (Sign & Relay) ---
    async function signAndRelay(func, args) {
        try {
            const nonceRes = await fetch(`${RENDER_API_URL}/get-nonce?user=${userAddress}`);
            const meta = await nonceRes.json();
            const iface = new ethers.Interface(MARKET_ABI);
            const data = iface.encodeFunctionData(func, args);
            
            const domain = { verifyingContract: meta.proxy, chainId: 137 };
            const types = { SafeTx: [{type:"address",name:"to"},{type:"uint256",name:"value"},{type:"bytes",name:"data"},{type:"uint8",name:"operation"},{type:"uint256",name:"safeTxGas"},{type:"uint256",name:"baseGas"},{type:"uint256",name:"gasPrice"},{type:"address",name:"gasToken"},{type:"address",name:"refundReceiver"},{type:"uint256",name:"nonce"}] };
            const message = { to: MARKET_ADDR, value: 0, data: data, operation: 0, safeTxGas: 0, baseGas: 0, gasPrice: 0, gasToken: "0x0000000000000000000000000000000000000000", refundReceiver: "0x0000000000000000000000000000000000000000", nonce: meta.nonce };

            const sig = await signer.signTypedData(domain, types, message);
            const res = await fetch(`${RENDER_API_URL}/relay-tx`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ proxy: meta.proxy, to: MARKET_ADDR, data, signature: sig }) });
            const json = await res.json();
            if(!json.success) throw new Error(json.error);
            return json.txHash;
        } catch(e) { alert(e.message); return null; }
    }

    async function handleCreateRequest() {
        const id = document.getElementById("b_tokenId").value;
        const sh = document.getElementById("b_shares").value;
        const pr = document.getElementById("b_principal").value;
        const dur = document.getElementById("b_duration").value; // Minutes
        // Convert Minutes to Seconds for contract
        const tx = await signAndRelay("createRequest", [id, BigInt(sh*1e6), BigInt(pr*1e6), BigInt(dur * 60)]);
        if(tx) { alert("‚úÖ Request Posted!"); location.reload(); }
    }

    async function loadMarketFeed() {
        const tbody = document.getElementById("marketFeed");
        const nextId = await marketContract.nextRequestId();
        let html = "";
        for(let i=Number(nextId)-1; i>=1; i--) {
            try {
                const req = await marketContract.requests(i); // borrower, tokenId, shares, principal, duration, isActive, isLoan
                if(req[5] === true && req[6] === false) { // Active & Not Loan
                    const info = await getInfo(req[1]);
                    const isMine = req[0].toLowerCase() === window.myProxy?.toLowerCase(); // Use proxy check
                    
                    let action = "";
                    if(isMine) action = `<button class="text-red-400 border border-red-900 px-3 py-1 rounded text-xs" onclick="handleCancel(${i})">Cancel</button>`;
                    else action = `<div class="flex gap-2"><input id="rate_${i}" placeholder="APR%" class="w-12 bg-black border border-gray-700 text-xs p-1"><button class="bg-brand px-3 py-1 rounded text-xs text-white" onclick="makeOffer(${i})">Offer</button></div>`;

                    html += `<tr class="border-b border-[#1E2129] hover:bg-[#0B0D12]"><td class="p-4"><div class="font-bold text-white">${info.title}</div><a href="${info.link}" target="_blank" class="text-xs text-brand">View Market ‚Üó</a><div class="text-[10px] text-gray-500 mt-1">${req[0].slice(0,6)}...</div></td><td class="p-4 text-right font-mono text-emerald-400">${ethers.formatUnits(req[2],6)}</td><td class="p-4 text-right font-mono text-white">$${ethers.formatUnits(req[3],6)}</td><td class="p-4 text-right text-gray-400">${(Number(req[4])/60).toFixed(0)}m</td><td class="p-4 text-right text-xs">View Offers</td><td class="p-4 text-right">${action}</td></tr>`;
                }
            } catch(e) {}
        }
        tbody.innerHTML = html;
    }

    async function loadMyLoans() {
        // Fetch Active Loans where I am Borrower
        const div = document.getElementById("borrowerLoans");
        const nextId = await marketContract.nextRequestId();
        let html = "";
        for(let i=1; i<Number(nextId); i++) {
            try {
                const loan = await marketContract.loans(i); // lender, startTime, rate, duration
                const req = await marketContract.requests(i);
                
                // If I am borrower
                if(req[6] && req[0].toLowerCase() === window.myProxy?.toLowerCase()) {
                    const end = Number(loan[1]) + Number(loan[3]);
                    const info = await getInfo(req[1]);
                    
                    html += `<div class="panel p-4 rounded border border-gray-800"><div class="flex justify-between mb-2"><span class="font-bold text-white">${info.title}</span><span class="text-xs bg-red-900 text-red-200 px-2 py-1 rounded" id="timer_${i}" data-end="${end}">Loading...</span></div><div class="flex justify-between text-xs text-gray-400"><span>Lender: ${loan[0].slice(0,6)}...</span><span>Rate: ${Number(loan[2])}%</span></div><div class="mt-4 flex gap-2"><button onclick="handleRepay(${i})" class="w-full bg-emerald-600 text-white py-2 rounded font-bold text-xs">Repay Loan</button><button onclick="handleExtend(${i})" class="w-full border border-gray-600 text-gray-400 py-2 rounded text-xs">Extend</button></div></div>`;
                }
            } catch(e) {}
        }
        div.innerHTML = html || "<p class='text-gray-500 text-sm'>No active loans.</p>";
    }

    function updateTimers() {
        document.querySelectorAll('[id^="timer_"]').forEach(el => {
            const end = Number(el.getAttribute("data-end"));
            const now = Math.floor(Date.now()/1000);
            const diff = end - now;
            if(diff <= 0) el.innerText = "LIQUIDATION RISK";
            else {
                const m = Math.floor(diff / 60);
                const s = diff % 60;
                el.innerText = `${m}m ${s}s Left`;
            }
        });
    }

    async function getInfo(id) {
        try {
            const res = await fetch(`${RENDER_API_URL}/market-info?tokenId=${id}`);
            return await res.json();
        } catch { return {title:"Unknown", link:"#"}; }
    }

    // Initialize
    async function initProxy() {
        try {
            const r = await fetch(`${RENDER_API_URL}/get-nonce?user=${userAddress}`);
            const d = await r.json();
            window.myProxy = d.proxy;
        } catch(e) {}
    }
    
    // Override connect to fetch proxy
    const _c = connectWallet;
    connectWallet = async () => { await _c(); await initProxy(); loadMarketFeed(); loadMyLoans(); }

    // Handlers (Simplified)
    async function makeOffer(id) {
        const rate = document.getElementById("rate_"+id).value;
        const usdc = new ethers.Contract(USDC_ADDR, ["function approve(address,uint256)"], signer);
        await (await usdc.approve(MARKET_ADDR, ethers.MaxUint256)).wait();
        await (await marketContract.makeOffer(id, Number(rate))).wait();
        alert("Offer Sent");
    }
    
    async function handleRepay(id) {
        if(confirm("Repay?")) if(await signAndRelay("repayLoan", [id])) alert("Repaid!");
    }
    
    async function handleCancel(id) {
        if(confirm("Cancel?")) if(await signAndRelay("cancelRequest", [id])) alert("Cancelled!");
    }
    </script>
</body>
</html>